<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie, maybe, or nah based on your local weather." />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  
  <style>
    :root {
      --bg: #0b0b0f;
      --panel: #0f1016;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.48);
      --shadow: 0 12px 36px rgba(0,0,0,.5);
      --radius: 16px;
      --radius2: 20px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      
      /* New design system colors */
      --sky-start: #1e3a8a;
      --sky-mid: #3b82f6;
      --sky-warm: #fb923c;
      --sky-peach: #fbbf24;
    }

    /* Baseline */
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      color: var(--text);
      /* Sky gradient background - transitions from blue to warm tones */
      background: 
        linear-gradient(135deg, 
          var(--sky-start) 0%, 
          var(--sky-mid) 35%, 
          var(--sky-warm) 75%, 
          var(--sky-peach) 100%
        );
      background-attachment: fixed;
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
    }
    
    a {
      color: inherit;
      text-decoration: none;
    }

    /* Container */
    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.15);
      /* Frosted glass effect */
      backdrop-filter: blur(20px);
      background: linear-gradient(135deg, 
        rgba(255,255,255,.12), 
        rgba(255,255,255,.08)
      );
      gap: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    header:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,.3);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .brand-btn {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.2);
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(59,130,246,.3), rgba(251,146,60,.3));
      font-size: 28px;
      transition: transform 0.2s ease;
    }
    
    .brand-btn:hover {
      transform: scale(1.05) rotate(5deg);
    }
    
    .wordmark .title {
      font-weight: 780;
      font-size: 18px;
    }
    
    .wordmark .tag {
      font-size: 11px;
      color: var(--muted2);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Fixed button/select styling */
    .btn, button {
      background: linear-gradient(135deg, rgba(59,130,246,.25), rgba(99,102,241,.25));
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
    }
    
    .btn:hover, button:hover {
      background: linear-gradient(135deg, rgba(59,130,246,.35), rgba(99,102,241,.35));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    
    .btn:active, button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, rgba(59,130,246,.4), rgba(251,146,60,.4));
      border-color: rgba(255,255,255,.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(59,130,246,.5), rgba(251,146,60,.5));
    }
    
    select, input[type="text"] {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-family: var(--font);
      font-size: 14px;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }
    
    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: rgba(59,130,246,.6);
      box-shadow: 0 0 0 3px rgba(59,130,246,.2);
    }
    
    select:hover, input[type="text"]:hover {
      border-color: rgba(255,255,255,.3);
    }

    .units-seg {
      display: inline-flex;
      gap: 4px;
      padding: 6px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
    }
    
    .units-seg button {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.2s ease;
    }
    
    .units-seg button:hover {
      background: rgba(255,255,255,.1);
      color: var(--text);
    }
    
    .units-seg button[aria-pressed="true"] {
      background: linear-gradient(135deg, rgba(59,130,246,.4), rgba(251,146,60,.4));
      color: var(--text);
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.2);
      background: linear-gradient(135deg, 
        rgba(255,255,255,.1), 
        rgba(255,255,255,.05)
      );
      backdrop-filter: blur(8px);
      max-width: 45%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .pill:hover {
      transform: scale(1.05);
      border-color: rgba(255,255,255,.3);
    }
    
    .pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(59,130,246,.8);
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.1);
      }
    }

    main {
      margin-top: 24px;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.15);
      padding: 24px;
      /* Frosted glass effect */
      backdrop-filter: blur(24px);
      background: linear-gradient(135deg, 
        rgba(255,255,255,.1), 
        rgba(255,255,255,.05)
      );
      box-shadow: 0 12px 48px rgba(0,0,0,.3);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
    }

    /* Cards */
    .card {
      border-radius: 24px;
      padding: 32px;
      /* Frosted glass card */
      background: linear-gradient(135deg, 
        rgba(255,255,255,.08), 
        rgba(255,255,255,.04)
      );
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.15);
      min-height: 420px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }
    
    .card-right {
      border-radius: 24px;
      padding: 24px;
      /* Frosted glass card */
      background: linear-gradient(135deg, 
        rgba(255,255,255,.08), 
        rgba(255,255,255,.04)
      );
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.15);
      min-height: 420px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }

    .big {
      font-weight: 900;
      /* Massive verdict text with colorful gradient - 140px on desktop */
      font-size: 140px;
      margin: 20px 0;
      line-height: 1;
      background: linear-gradient(135deg, 
        #3b82f6 0%, 
        #8b5cf6 25%, 
        #ec4899 50%, 
        #f59e0b 75%, 
        #10b981 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 6s ease infinite;
      background-size: 200% 200%;
    }
    
    @keyframes gradientShift {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }
    
    .sub {
      color: var(--muted);
      font-size: 18px;
      margin: 10px 0 30px;
      font-weight: 500;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 24px;
    }
    
    .stat {
      background: linear-gradient(135deg, 
        rgba(255,255,255,.1), 
        rgba(255,255,255,.05)
      );
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,.15);
      transition: all 0.3s ease;
    }
    
    .stat:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,.2);
    }
    
    .stat .k {
      font-size: 11px;
      color: var(--muted2);
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .stat .v {
      font-size: 18px;
      font-weight: 800;
      margin-top: 6px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255,255,255,.2), 
        transparent
      );
      margin: 24px 0;
    }

    /* Location controls */
    .location-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .location-input-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .location-input-group input {
      flex: 1;
      min-width: 200px;
    }
    
    .last-updated {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
    }

    /* Forecast list - horizontal scrolling */
    .forecast-list {
      display: flex;
      gap: 12px;
      padding: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.3) transparent;
    }
    
    .forecast-list::-webkit-scrollbar {
      height: 8px;
    }
    
    .forecast-list::-webkit-scrollbar-track {
      background: rgba(255,255,255,.05);
      border-radius: 4px;
    }
    
    .forecast-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.3);
      border-radius: 4px;
    }
    
    .forecast-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.5);
    }
    
    .forecast-item {
      flex: 0 0 auto;
      width: 160px;
      background: linear-gradient(135deg, 
        rgba(255,255,255,.1), 
        rgba(255,255,255,.05)
      );
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,.15);
      cursor: pointer;
      transition: all 0.3s ease;
      scroll-snap-align: start;
    }
    
    .forecast-item:focus, .forecast-item:hover {
      transform: translateY(-8px) scale(1.02);
      background: linear-gradient(135deg, 
        rgba(59,130,246,.2), 
        rgba(251,146,60,.2)
      );
      border-color: rgba(255,255,255,.3);
      box-shadow: 0 12px 32px rgba(0,0,0,.3);
    }
    
    .forecast-item .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .forecast-item .day {
      font-weight: 800;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .forecast-item .temp {
      font-weight: 700;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .forecast-item .verdict {
      font-weight: 900;
      color: var(--text);
      margin-top: 8px;
      font-size: 15px;
    }

    /* Desktop forecast button */
    .show-forecast-btn {
      display: none;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, 
        rgba(255,255,255,.15), 
        rgba(255,255,255,.1)
      );
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px;
      padding: 16px 28px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 12px 48px rgba(0,0,0,.4);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      max-width: 90%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: all;
    }
    
    .toast.error {
      border-color: rgba(255, 107, 107, 0.5);
      background: linear-gradient(135deg, 
        rgba(255, 107, 107, 0.2), 
        rgba(255, 107, 107, 0.1)
      );
    }

    /* Bottom sheet for mobile - initially hidden */
    .bottom-sheet-backdrop {
      display: none;
    }
    
    .bottom-sheet {
      display: none;
    }

    /* Footer */
    .site-footer {
      margin-top: 24px;
      border-radius: 16px;
      padding: 16px 20px;
      border: 1px solid rgba(255,255,255,.15);
      background: linear-gradient(135deg, 
        rgba(0,0,0,.3), 
        rgba(0,0,0,.2)
      );
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      color: var(--muted);
      font-size: 13px;
      flex-wrap: wrap;
    }
    
    .site-footer a {
      color: rgba(59,130,246,.9);
      transition: color 0.2s ease;
    }
    
    .site-footer a:hover {
      color: rgba(251,146,60,.9);
    }

    /* Reduced UI for low-power devices */
    .reduced-ui * {
      box-shadow: none !important;
      transition: none !important;
      animation: none !important;
    }
    
    .reduced-ui .forecast-item:hover,
    .reduced-ui .forecast-item:focus {
      transform: none;
    }

    /* Accessibility / reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        animation: none !important;
      }
    }

    /* Responsive: mobile layout with bottom sheet */
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      /* Hide right column on mobile, use bottom sheet instead */
      .card-right {
        display: none;
      }
      
      /* Show forecast toggle button on mobile */
      .show-forecast-btn {
        display: block;
        width: 100%;
        margin-top: 16px;
      }
      
      /* Bottom sheet styles */
      .bottom-sheet-backdrop {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,.70);
        backdrop-filter: blur(8px);
        z-index: 998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .bottom-sheet-backdrop.open {
        opacity: 1;
        pointer-events: all;
      }
      
      .bottom-sheet {
        display: flex;
        flex-direction: column;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, 
          rgba(30,58,138,.95), 
          rgba(59,130,246,.95)
        );
        backdrop-filter: blur(24px);
        border-top-left-radius: 28px;
        border-top-right-radius: 28px;
        border: 1px solid rgba(255,255,255,.2);
        border-bottom: none;
        max-height: 85vh;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 999;
        box-shadow: 0 -12px 64px rgba(0,0,0,.5);
      }
      
      .bottom-sheet.open {
        transform: translateY(0);
      }
      
      .bottom-sheet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,.2);
        flex-shrink: 0;
      }
      
      .bottom-sheet-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 800;
      }
      
      .bottom-sheet-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        overscroll-behavior: contain;
      }
      
      .bottom-sheet .forecast-list {
        flex-wrap: wrap;
        overflow-x: hidden;
      }
      
      .forecast-item {
        flex: 0 0 calc(50% - 12px);
        width: auto;
      }
    }

    @media (max-width: 520px) {
      .forecast-item {
        flex: 0 0 100%;
        width: 100%;
      }
      
      .big {
        font-size: 72px;
      }
      
      header {
        padding: 12px 16px;
      }
      
      .wrap {
        padding: 16px;
      }
      
      .card {
        padding: 20px;
      }
      
      .units-seg button {
        padding: 8px 12px;
      }
      
      .location-input-group {
        flex-direction: column;
      }
      
      .location-input-group input {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-btn">üß•</div>
        <div class="wordmark">
          <div class="title">Hoodie or Nah</div>
          <div class="tag">Weather, simplified</div>
        </div>
      </div>
      <div class="header-right">
        <div class="units-seg" role="group" aria-label="Temperature units">
          <button id="unit-f" aria-pressed="true" onclick="setUnit('F')">¬∞F</button>
          <button id="unit-c" aria-pressed="false" onclick="setUnit('C')">¬∞C</button>
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <div class="card">
          <div class="location-controls">
            <div class="location-input-group">
              <button class="btn btn-primary" onclick="useGPS()">üìç Use my GPS</button>
              <input 
                type="text" 
                id="manual-location" 
                placeholder="Or enter lat,lon (e.g., 40.7128,-74.0060)" 
                onkeypress="if(event.key==='Enter') useManualLocation()"
              />
              <button class="btn" onclick="useManualLocation()">Go</button>
            </div>
            <div class="location-input-group">
              <button class="btn" id="refresh-btn" onclick="refreshWeather()">üîÑ Refresh</button>
              <div class="last-updated" id="last-updated"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="verdict-display">
            <div class="big" id="verdict-text">‚Äî</div>
            <div class="sub" id="verdict-subtitle">Load weather to get started</div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">TEMP</div>
              <div class="v" id="stat-temp">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">FEELS LIKE</div>
              <div class="v" id="stat-feels">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">WIND</div>
              <div class="v" id="stat-wind">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">LOCATION</div>
              <div class="v" id="stat-location">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div>
            <label for="temp-preference" style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--muted);">
              How do you run?
            </label>
            <select id="temp-preference" onchange="updateVerdict()">
              <option value="0">Normal</option>
              <option value="-3">I run warm</option>
              <option value="3">I run cold</option>
            </select>
          </div>
        </div>

        <div class="card-right">
          <h3 style="margin: 0 0 8px 0; font-size: 16px;">7-Day Forecast</h3>
          <div class="forecast-list" id="forecast-list">
            <div style="color: var(--muted); font-size: 14px;">Load weather data to see forecast</div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary show-forecast-btn" onclick="toggleBottomSheet()">
        üìä Open forecast
      </button>
    </main>

    <footer class="site-footer">
      <div>
        Made with ‚òï | 
        <a href="https://github.com/oopsyoublinked/hoodieornah" target="_blank" rel="noopener">GitHub</a>
      </div>
      <div>
        Data from <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a>
      </div>
    </footer>
  </div>

  <!-- Bottom sheet for mobile -->
  <div class="bottom-sheet-backdrop" id="bottom-sheet-backdrop" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="bottom-sheet" role="dialog" aria-modal="true" aria-labelledby="sheet-title">
    <div class="bottom-sheet-header">
      <h3 id="sheet-title">7-Day Forecast</h3>
      <button class="btn" onclick="closeBottomSheet()" aria-label="Close forecast">Close</button>
    </div>
    <div class="bottom-sheet-content">
      <div class="forecast-list" id="forecast-list-mobile">
        <div style="color: var(--muted); font-size: 14px;">Load weather data to see forecast</div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast" role="alert" aria-live="polite"></div>

  <script>
    // ========================================
    // Toast Notification System
    // ========================================
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ========================================
    // Cache Helper with localStorage
    // ========================================
    const CACHE_PREFIX = 'hoodie:cache:';

    /**
     * Fetch with cache
     * @param {string} key - Cache key
     * @param {function} fetcher - Async function that returns data
     * @param {number} ttlMs - Time to live in milliseconds
     * @param {boolean} force - Force fresh fetch, bypass cache
     * @returns {Promise<{data: any, fromCache: boolean, ts: number}>}
     */
    async function fetchWithCache(key, fetcher, ttlMs, force = false) {
      const cacheKey = CACHE_PREFIX + key;
      const now = Date.now();

      // Check cache unless forced
      if (!force) {
        try {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            const parsed = JSON.parse(cached);
            const age = now - parsed.ts;
            if (age < ttlMs) {
              console.log(`Cache hit for ${key}, age: ${Math.round(age / 1000)}s`);
              return { data: parsed.data, fromCache: true, ts: parsed.ts };
            }
          }
        } catch (e) {
          console.warn('Cache read error:', e);
        }
      }

      // Fetch fresh data
      console.log(`Fetching fresh data for ${key}`);
      const data = await fetcher();
      const cacheObj = { ts: now, data };

      try {
        localStorage.setItem(cacheKey, JSON.stringify(cacheObj));
      } catch (e) {
        console.warn('Cache write error:', e);
      }

      return { data, fromCache: false, ts: now };
    }

    // ========================================
    // Device Heuristics
    // ========================================
    function applyDeviceHeuristics() {
      const cores = navigator.hardwareConcurrency || 4;
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const effectiveType = connection ? connection.effectiveType : '4g';

      const isLowPower = cores < 2 || ['slow-2g', '2g', '3g'].includes(effectiveType);

      if (isLowPower) {
        document.documentElement.classList.add('reduced-ui');
        console.log('Low-power device detected, applying reduced UI');
      }
    }

    // ========================================
    // State Management
    // ========================================
    let currentUnit = 'F';
    let currentWeatherData = null;
    let currentForecastData = null;
    let currentLocation = { lat: null, lon: null, name: 'Unknown' };

    function setUnit(unit) {
      currentUnit = unit;
      document.getElementById('unit-f').setAttribute('aria-pressed', unit === 'F');
      document.getElementById('unit-c').setAttribute('aria-pressed', unit === 'C');
      
      // Re-render if we have data
      if (currentWeatherData) {
        updateVerdict();
      }
      if (currentForecastData) {
        renderForecast(currentForecastData);
      }
    }

    function tempConvert(tempC, unit) {
      if (unit === 'C') return Math.round(tempC);
      return Math.round(tempC * 9/5 + 32);
    }

    // ========================================
    // Weather Logic
    // ========================================
    function getVerdict(tempC, preference = 0) {
      const adjustedTemp = tempC + preference;
      
      if (adjustedTemp < 16) return { text: 'Hoodie', icon: 'üß•', color: '#6B9FFF' };
      if (adjustedTemp < 20) return { text: 'Maybe', icon: 'ü§î', color: '#FFB366' };
      return { text: 'Nah', icon: '‚òÄÔ∏è', color: '#FF6B6B' };
    }

    function updateVerdict() {
      if (!currentWeatherData) return;

      const preference = parseInt(document.getElementById('temp-preference').value || 0);
      const verdict = getVerdict(currentWeatherData.temperature, preference);

      document.getElementById('verdict-text').textContent = verdict.text;
      document.getElementById('verdict-text').style.color = verdict.color;
      document.getElementById('verdict-subtitle').textContent = `${verdict.icon} Based on current conditions`;

      // Update stats
      const temp = tempConvert(currentWeatherData.temperature, currentUnit);
      const feels = tempConvert(currentWeatherData.apparent_temperature || currentWeatherData.temperature, currentUnit);
      
      document.getElementById('stat-temp').textContent = `${temp}¬∞${currentUnit}`;
      document.getElementById('stat-feels').textContent = `${feels}¬∞${currentUnit}`;
      
      // Convert wind speed based on unit preference
      const windSpeed = currentWeatherData.windspeed || 0;
      const windDisplay = currentUnit === 'C' 
        ? `${Math.round(windSpeed * 1.60934)} km/h`  // Convert mph to km/h
        : `${Math.round(windSpeed)} mph`;
      document.getElementById('stat-wind').textContent = windDisplay;
      
      document.getElementById('stat-location').textContent = currentLocation.name;
    }

    function renderForecast(forecastData) {
      if (!forecastData || !forecastData.daily) return;

      const days = forecastData.daily.time || [];
      const maxTemps = forecastData.daily.temperature_2m_max || [];
      const minTemps = forecastData.daily.temperature_2m_min || [];

      let html = '';
      for (let i = 0; i < Math.min(days.length, 7); i++) {
        const date = new Date(days[i]);
        const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
        const avgTemp = (maxTemps[i] + minTemps[i]) / 2;
        const verdict = getVerdict(avgTemp);
        
        const maxDisplay = tempConvert(maxTemps[i], currentUnit);
        const minDisplay = tempConvert(minTemps[i], currentUnit);

        html += `
          <div class="forecast-item" tabindex="0">
            <div class="icon">${verdict.icon}</div>
            <div class="day">${dayName}</div>
            <div class="temp">${maxDisplay}¬∞ / ${minDisplay}¬∞${currentUnit}</div>
            <div class="verdict" style="color: ${verdict.color}">${verdict.text}</div>
          </div>
        `;
      }

      // Update both desktop and mobile forecast lists
      document.getElementById('forecast-list').innerHTML = html;
      document.getElementById('forecast-list-mobile').innerHTML = html;
    }

    function formatTimestamp(ts) {
      if (!ts) return 'Never';
      const date = new Date(ts);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      
      if (diffMin < 1) return 'Just now';
      if (diffMin < 60) return `${diffMin} min ago`;
      
      const diffHour = Math.floor(diffMin / 60);
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // ========================================
    // API Calls
    // ========================================
    async function fetchWeather(lat, lon, force = false) {
      try {
        // Fetch current weather
        const currentResult = await fetchWithCache(
          `weather:${lat}:${lon}`,
          async () => {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,windspeed_10m&temperature_unit=celsius&windspeed_unit=mph`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Weather API error');
            return res.json();
          },
          5 * 60 * 1000, // 5 min TTL
          force
        );

        currentWeatherData = {
          temperature: currentResult.data.current.temperature_2m,
          apparent_temperature: currentResult.data.current.apparent_temperature,
          windspeed: currentResult.data.current.windspeed_10m
        };

        // Fetch 7-day forecast
        const forecastResult = await fetchWithCache(
          `forecast:${lat}:${lon}`,
          async () => {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&temperature_unit=celsius&timezone=auto`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Forecast API error');
            return res.json();
          },
          60 * 60 * 1000, // 1 hour TTL
          force
        );

        currentForecastData = forecastResult.data;

        // Update UI
        updateVerdict();
        renderForecast(currentForecastData);

        // Update last updated timestamp (use most recent)
        const latestTs = Math.max(currentResult.ts, forecastResult.ts);
        document.getElementById('last-updated').textContent = `Last updated: ${formatTimestamp(latestTs)}`;

        if (!force && currentResult.fromCache) {
          console.log('Loaded from cache');
        } else {
          console.log('Loaded fresh data');
        }
      } catch (error) {
        console.error('Error fetching weather:', error);
        showToast('Failed to fetch weather data. Please try again.', true);
      }
    }

    async function useGPS() {
      if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', true);
        return;
      }

      document.getElementById('verdict-subtitle').textContent = 'Getting your location...';

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          currentLocation = {
            lat,
            lon,
            name: `${lat.toFixed(2)}, ${lon.toFixed(2)}`
          };
          await fetchWeather(lat, lon);
        },
        (error) => {
          console.error('Geolocation error:', error);
          showToast('Could not get your location. Please enter manually.', true);
          document.getElementById('verdict-subtitle').textContent = 'Location access denied';
        }
      );
    }

    function useManualLocation() {
      const input = document.getElementById('manual-location').value.trim();
      if (!input) {
        showToast('Please enter a location in lat,lon format', true);
        return;
      }

      const parts = input.split(',').map(p => p.trim());
      if (parts.length !== 2) {
        showToast('Invalid format. Use: latitude,longitude (e.g., 40.7128,-74.0060)', true);
        return;
      }

      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);

      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        showToast('Invalid coordinates. Latitude must be -90 to 90, longitude -180 to 180', true);
        return;
      }

      currentLocation = { lat, lon, name: `${lat.toFixed(2)}, ${lon.toFixed(2)}` };
      fetchWeather(lat, lon);
    }

    function refreshWeather() {
      if (!currentLocation.lat || !currentLocation.lon) {
        showToast('Please load weather data first', true);
        return;
      }

      document.getElementById('last-updated').textContent = 'Refreshing...';
      fetchWeather(currentLocation.lat, currentLocation.lon, true);
    }

    // ========================================
    // Bottom Sheet (Mobile)
    // ========================================
    const SHEET_STATE_KEY = 'hoodie:sheet-open';

    function toggleBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      const isOpen = sheet.classList.contains('open');

      if (isOpen) {
        closeBottomSheet();
      } else {
        openBottomSheet();
      }
    }

    function openBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      
      sheet.classList.add('open');
      backdrop.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      // Save state
      sessionStorage.setItem(SHEET_STATE_KEY, 'true');
      
      // Update button text
      const btn = document.querySelector('.show-forecast-btn');
      if (btn) btn.textContent = '‚ùå Close forecast';
    }

    function closeBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      
      sheet.classList.remove('open');
      backdrop.classList.remove('open');
      document.body.style.overflow = '';
      
      // Save state
      sessionStorage.setItem(SHEET_STATE_KEY, 'false');
      
      // Update button text
      const btn = document.querySelector('.show-forecast-btn');
      if (btn) btn.textContent = 'üìä Open forecast';
    }

    // Keyboard accessibility
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sheet = document.getElementById('bottom-sheet');
        if (sheet.classList.contains('open')) {
          closeBottomSheet();
        }
      }
    });

    // ========================================
    // Initialization
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      // Apply device heuristics
      applyDeviceHeuristics();

      // Restore bottom sheet state on mobile
      const sheetState = sessionStorage.getItem(SHEET_STATE_KEY);
      if (sheetState === 'true' && window.innerWidth <= 900) {
        // Small delay to allow CSS to load
        setTimeout(() => openBottomSheet(), 100);
      }

      console.log('Hoodie or Nah - Ready!');
      console.log('Use "Use my GPS" or enter lat,lon to get started');
    });
  </script>
</body>
</html>
