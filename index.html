<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie, maybe, or nah based on your local weather." />
  <meta name="theme-color" content="#0b0b0f" />

  <meta property="og:image" content="https://hoodieornah.com/og.png" />
  <meta name="twitter:card" content="summary_large_image">

  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="/favicon-32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/favicon-16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
  <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192" />
  <link rel="icon" type="image/png" href="/android-chrome-512x512.png" sizes="512x512" />

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#0f1016;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.48);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      --drawer-bg: rgba(255,255,255,.02);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{color-scheme: dark}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(120,160,255,.08), transparent 45%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.04), transparent 55%),
        var(--bg);
      color:var(--text);
      transition: filter .28s ease, background-color .28s ease;
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px;
      position: relative;
      z-index: 1;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position: sticky; /* Sticky base */
      top: 14px;        /* Gap from top */
      backdrop-filter: blur(8px);
      z-index: 100;     /* Ensure it stays on top */
      gap: 12px;
    }

    .brand{ display:flex; align-items:center; gap: 10px; min-width: 0; }

    .brand-btn{
      width: 56px; height: 56px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.08), rgba(255,255,255,.02));
      display:grid; place-items:center; padding:0; cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 8px 28px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .brand-btn img{ width: 44px; height: 44px; display:block; filter: drop-shadow(0 8px 14px rgba(0,0,0,.55)); border-radius: 10px; }

    .wordmark{ display:flex; flex-direction:column; line-height:1.05; min-width:0; }
    .wordmark .title{ font-size: 18px; font-weight: 780; letter-spacing: .2px; white-space: nowrap; }
    .wordmark .tag{ font-size: 11px; color: var(--muted2); letter-spacing: .2px; margin-top: 2px; }

    .header-right{ display:flex; align-items:center; gap: 10px; min-width: 0; flex: 1 1 auto; justify-content:flex-end; }

    .units-seg{
      display:inline-flex; border-radius: 999px; background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.06); padding: 4px; gap: 6px; align-items:center; font-size: 13px; flex: 0 0 auto;
    }
    .units-seg button{
      padding: 6px 10px; border-radius: 999px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 700;
    }
    .units-seg button[aria-pressed="true"]{ background: rgba(255,255,255,.06); color: var(--text); border-radius: 999px; }

    .pill{
      display:inline-flex; align-items:center; gap: 8px; padding: 6px 10px;
      border-radius: 999px; border: 1px solid var(--border2); background: rgba(255,255,255,.03);
      color: var(--text); font-weight: 650; letter-spacing: .2px; user-select:none;
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 0 1 auto;
      max-width: 45%; cursor: pointer;
    }
    .pill:focus{ outline: none; box-shadow: 0 6px 22px rgba(100,150,255,.08); }
    .pill .dot{ width: 8px; height: 8px; border-radius: 999px; background: rgba(255,255,255,.32); box-shadow: 0 0 0 4px rgba(255,255,255,.04); flex: 0 0 auto; }

    main{
      margin-top: 14px; border: 1px solid var(--border); border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow: var(--shadow); padding: 14px; transition: box-shadow .22s ease;
    }

    .grid{ display:grid; grid-template-columns: 1.45fr 1fr; gap: 14px; }
    
    /* FIX: Improved Mobile/Landscape Layout */
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .pill{ max-width: 60%; }
      
      header {
        top: 10px; /* Ensure gap is correct on mobile */
      }
    }

    .card{
      border-radius: var(--radius); border: 1px solid var(--border2);
      background: radial-gradient(900px 500px at 10% 0%, rgba(120,160,255,.06), transparent 42%), radial-gradient(700px 420px at 85% 10%, rgba(255,255,255,.04), transparent 50%), rgba(0,0,0,.22);
      padding: 14px; min-height: 420px; position:relative; overflow:hidden; z-index: 2;
    }

    .card-right{
      border-radius: var(--radius); border: 1px solid var(--border2); background: rgba(0,0,0,.18);
      padding: 12px; min-height: 420px; display:flex; flex-direction:column; gap: 10px; z-index: 2; position:relative;
    }

    .big{ font-size: 66px; font-weight: 900; letter-spacing: .6px; margin: 8px 0 6px; transition: opacity .22s ease, transform .18s ease; will-change: opacity, transform; }
    .big.fade{ opacity: 0; transform: translateY(6px) scale(.995); }
    @media (max-width: 560px){ .big{font-size: 48px} }
    .sub{ color: var(--muted); font-size: 14px; margin: 0 0 10px; max-width: 52ch; transition: opacity .22s ease, transform .18s ease; }

    .divider{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }
    @media (max-width: 560px){ .stats{grid-template-columns:1fr} }

    .stat{ border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); border-radius: 14px; padding: 10px; }
    .stat .k{ font-size: 12px; color: var(--muted2); font-weight: 750; letter-spacing: .2px; margin-bottom: 6px; }
    .stat .v{ font-size: 15px; font-weight: 820; letter-spacing: .2px; }
    .stat .s{ font-size: 12px; color: var(--muted); margin-top: 4px; line-height: 1.35; }

    h3{ margin: 0 0 6px; font-size: 20px; font-weight: 820; letter-spacing: .2px; }
    label{ display:block; font-size: 13px; color: var(--muted); margin: 8px 0 8px; font-weight: 650; }

    select, input{
      width:100%; padding: 10px 12px; border-radius: 999px; border: 1px solid var(--border2);
      background: rgba(255,255,255,.03); color: var(--text); outline: none; font-size: 14px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    input::placeholder{color: rgba(255,255,255,.35)}
    select{ color-scheme: dark; background-color: rgba(255,255,255,.03); }

    .btn-row{ display:flex; gap: 8px; margin-top: 6px; flex-wrap: wrap; }

    button{
      padding: 10px 12px; border-radius: 999px; border: 1px solid var(--border2); background: rgba(255,255,255,.04);
      color: var(--text); font-weight: 740; letter-spacing: .2px; cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); }
    button:active{ transform: translateY(0px) scale(.99) }
    button:disabled{ opacity:.48; cursor:not-allowed; transform:none; }

    .mini{ border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); border-radius: 16px; padding: 10px 12px; margin-top: 6px; }
    .mini .row{ display:flex; justify-content:space-between; gap: 12px; align-items:flex-start; padding: 6px 2px; color: var(--muted); font-weight: 650; font-size: 13px; }
    .mini .row strong{ color: var(--text); font-weight: 820; }

    .in-card-footer{ display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-top: 12px; color: var(--muted); font-weight: 650; padding: 2px 2px 0; flex-wrap: wrap; }

    .forecast-list{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-start; padding: 6px 2px 2px; margin-top: 6px; }
    .forecast-item{
      flex: 0 0 calc(20% - 9.6px); min-width: 120px; max-width: 210px; border-radius: 12px; padding: 10px;
      background: rgba(255,255,255,.02); border: 1px solid rgba(255,255,255,.06); display:flex; flex-direction:column; gap:8px;
      font-size:13px; color:var(--muted); align-items:flex-start; transition: transform .14s ease, box-shadow .14s ease, background .12s ease; cursor: pointer;
    }
    .forecast-item:focus, .forecast-item:hover{ transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,.6); background: rgba(255,255,255,.028); outline: none; }
    .forecast-item .row{ display:flex; gap:8px; align-items:center; }
    .forecast-item .day{ font-weight:820; color:var(--text); font-size:13px; }
    .forecast-item .temp{ font-weight:780; color:var(--text); font-size:13px; }
    .forecast-item .icon{ width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; color:var(--text); flex:0 0 auto; }
    .forecast-item .verdict{ font-weight:900; font-size:15px; color:var(--text); }
    .forecast-item .snark{ color:var(--muted); font-size:12px; line-height:1.25; }

    .support{
      display:inline-flex; align-items:center; gap: 10px; padding: 10px 12px; border-radius: 999px;
      border: 1px solid var(--border); background: rgba(255,255,255,.02); text-decoration:none;
      color: var(--text); font-weight: 780; margin-top:12px;
    }
    .support:hover{border-color: rgba(255,255,255,.18)}
    .support svg{ width: 16px; height: 16px; opacity: .9; flex: 0 0 auto; }

    .details-drawer{
      margin-top: 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,.06); background: var(--drawer-bg);
      padding: 12px; min-height: 180px; color: var(--muted); display:flex; flex-direction:column; gap:8px;
    }
    .details-drawer h4{ margin:0; font-size:16px; color:var(--text); }
    .details-meta{ color:var(--muted); font-size:13px; }
    .sparkline{ width:100%; height:48px; display:block; margin-top:6px; }

    .site-footer{
      margin-top: 14px; border: 1px solid rgba(255,255,255,.10); border-radius: 16px; background: rgba(0,0,0,.18);
      padding: 12px 12px; display:flex; justify-content:space-between; gap: 12px; align-items:flex-start;
      color: var(--muted); font-size: 12px; line-height: 1.5;
    }
    .site-footer a{ color: rgba(255,255,255,.82); text-decoration:none; border-bottom: 1px solid rgba(255,255,255,.20); }
    .site-footer a:hover{ border-bottom-color: rgba(255,255,255,.40); }

    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 60; }
    .modal{ background: #0f1016; border: 1px solid rgba(255,255,255,.06); padding: 18px; border-radius: 12px; max-width: 520px; width: 92%; color: var(--text); box-shadow: 0 18px 60px rgba(0,0,0,.65); }

    .toast{
      position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); padding: 12px 14px;
      border-radius: 999px; border: 1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.75);
      color: var(--text); box-shadow: var(--shadow); opacity: 0; pointer-events:none; transition: opacity .18s ease, transform .18s ease;
      z-index: 30; max-width: min(760px, calc(100% - 24px)); text-align:center; font-weight: 700;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

    @media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }
    @media (max-width: 1200px){ .forecast-item{ flex: 0 0 calc(33.333% - 12px); } }
    @media (max-width: 760px){ .forecast-item{ flex: 0 0 calc(50% - 12px); } }
    @media (max-width: 480px){ .forecast-item{ flex: 0 0 calc(100% - 12px); } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <button class="brand-btn" id="brandHome" aria-label="Hoodie or Nah home">
          <img src="/android-chrome-192x192.png" alt="Hoodie or Nah logo" />
        </button>

        <div class="wordmark">
          <div class="title">Hoodie or Nah</div>
          <div class="tag">Hoodie judgment, delivered.</div>
        </div>
      </div>

      <div class="header-right">
        <div class="units-seg" role="group" aria-label="Units">
          <button id="unitAuto" aria-pressed="true" title="Auto units (based on country)">Auto</button>
          <button id="unitF" aria-pressed="false" title="Force Fahrenheit">Â°F</button>
          <button id="unitC" aria-pressed="false" title="Force Celsius">Â°C</button>
        </div>

        <div class="pill" id="wherePill" title="Near you" aria-live="polite" tabindex="0">
          <span class="dot" aria-hidden="true"></span>
          <span id="whereText">Near you</span>
        </div>
      </div>
    </header>

    <main id="mainShell">
      <div class="grid">
        <section class="card" aria-live="polite" aria-atomic="true">
          <div class="big" id="bigWord">LOADING</div>
          <p class="sub" id="oneLiner">Grabbing your weather. Try not to panic.</p>

          <div class="divider"></div>

          <div class="stats">
            <div class="stat">
              <div class="k">Location</div>
              <div class="v" id="locLine">Near you</div>
              <div class="s" id="locSource">Source: guessing until you say otherwise.</div>
            </div>

            <div class="stat">
              <div class="k">Right now</div>
              <div class="v" id="tempLine">--</div>
              <div class="s" id="feelWindLine">Feels like: --  |  Wind: --</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="in-card-footer" style="flex-direction:column;align-items:stretch;">
            <div id="forecastPanel" style="flex:1 1 auto; min-width:220px;">
              <div class="forecast-list" id="forecastList" aria-live="polite" aria-atomic="false"></div>
              <div style="margin-top:8px;color:var(--muted);font-size:13px;" id="unitsFooter">Units: --</div>
            </div>
          </div>

          <a class="support" href="https://buymeacoffee.com/hoodieornah" target="_blank" rel="noopener" id="supportBtn">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6.5 8.2h9.2c.8 0 1.4.6 1.4 1.4v3.7c0 2.7-2.2 4.9-4.9 4.9H10c-2.7 0-4.9-2.2-4.9-4.9V9.6c0-.8.6-1.4 1.4-1.4Z" stroke="rgba(255,255,255,.88)" stroke-width="1.7"/>
              <path d="M17.1 9.6h1.1c1.3 0 2.3 1 2.3 2.3s-1 2.3-2.3 2.3h-1.1" stroke="rgba(255,255,255,.78)" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M7.6 21h9.2" stroke="rgba(255,255,255,.50)" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
            <span>Support the hoodie science</span>
          </a>
        </section>

        <aside class="card-right" aria-live="polite">
          <div>
            <h3>How do you run?</h3>
            <select id="runSelect" aria-label="How do you run">
              <option value="cold">Always cold</option>
              <option value="normal" selected>Normal</option>
              <option value="hot">Always hot</option>
            </select>

            <label for="manualInput">Manual location (optional)</label>
            <input id="manualInput" list="locList" placeholder="City, Region, Country or ZIP" autocomplete="off" />
            <datalist id="locList"></datalist>

            <div class="btn-row">
              <button id="spinBtn" type="button">Spin the globe</button>
              <button id="gpsBtn" type="button">Use my GPS</button>
            </div>
          </div>

          <div class="mini" aria-live="polite" id="summaryPanel">
            <div class="row"><span>Using</span><strong id="usingLine">Auto</strong></div>
            <div class="row"><span>Location</span><strong id="usingLoc">Near you</strong></div>
            <div class="row"><span>Units</span><strong id="usingUnits">--</strong></div>
            <div class="row"><span>Actions</span><strong id="actionsLine">Click the location for details or copy</strong></div>
          </div>

          <div id="detailsDrawer" class="details-drawer" aria-hidden="true">
            <div id="drawerHeader" style="display:flex;justify-content:space-between;align-items:center;">
              <h4 id="drawerTitle">Select a day for details</h4>
              <button id="drawerClose" aria-label="Close details" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--muted)">Close</button>
            </div>
            <div id="drawerBody" style="display:block;">
              <div class="details-meta" id="drawerMeta">No day selected.</div>
              <div id="drawerContent" style="margin-top:6px;color:var(--muted)"></div>
              <svg class="sparkline" id="drawerSpark" viewBox="0 0 200 48" preserveAspectRatio="none" aria-hidden="true"></svg>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <div class="site-footer">
      <div>
        <strong style="color:rgba(255,255,255,.86);">Contact</strong><br/>
        <a href="mailto:info@hoodieornah.com">info@hoodieornah.com</a><br/>
        <span style="color:rgba(255,255,255,.42);">We read it. Eventually.</span>
      </div>

      <div style="text-align:right; max-width: 64ch;">
        Weather data via Open-Meteo. Geocoding via OpenStreetMap Nominatim.<br/>
        This site is for entertainment and mild arguments only. No warranties. Do not sue us because you wore a hoodie in a blizzard.
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" id="modal">
      <div>
        <h3 id="modalTitle">Day details</h3>
        <div id="modalContent"></div>
        <div class="modal-row" style="margin-top:14px; display:flex; gap:10px;">
          <button id="shareTakeBtn">Copy share text</button>
          <button id="closeModalBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <script>
    // ---------- Storage + defaults ----------
    const STORAGE_KEY = "hoodie_state_v4";
    const SPIN_POOL_KEY = "hoodie_spin_pool_v4";
    const API_CACHE_KEY = "hoodie_api_cache_v2";
    const CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

    const defaultState = {
      run: "normal",
      source: "auto",
      placeLabel: "Near you",
      lat: null,
      lon: null,
      countryCode: null,
      units: "F",
      unitOverride: null,
      lastDecision: { word: "MAYBE", line: "" },
      pillBehavior: "modal"
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return Object.assign({}, defaultState);
        return Object.assign({}, defaultState, JSON.parse(raw) || {});
      }catch(e){
        return Object.assign({}, defaultState);
      }
    }
    const state = loadState();

    function saveState(){
      try{
        const toSave = {
          run: state.run,
          source: state.source,
          placeLabel: state.placeLabel,
          lat: state.lat,
          lon: state.lon,
          countryCode: state.countryCode,
          units: state.units,
          unitOverride: state.unitOverride,
          lastDecision: state.lastDecision,
          pillBehavior: state.pillBehavior
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      }catch(e){}
    }

    // ---------- Simple Cache Helpers ----------
    function readCache(){
      try{
        const raw = localStorage.getItem(API_CACHE_KEY);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      }catch(e){ return {}; }
    }
    function writeCache(cache){
      try{ localStorage.setItem(API_CACHE_KEY, JSON.stringify(cache)); }catch(e){}
    }
    function getCached(key, maxAge = CACHE_TTL_MS){
      const cache = readCache();
      const entry = cache[key];
      if (!entry) return null;
      if ((Date.now() - entry.ts) > maxAge) {
        delete cache[key];
        writeCache(cache);
        return null;
      }
      return entry.val;
    }
    function setCached(key, val){
      const cache = readCache();
      cache[key] = { ts: Date.now(), val };
      writeCache(cache);
    }

    // ---------- DOM Refs ----------
    const el = {
      header: document.querySelector('header'),
      brand: document.querySelector('.brand'),
      wherePill: document.getElementById("wherePill"),
      whereText: document.getElementById("whereText"),
      unitAuto: document.getElementById("unitAuto"),
      unitF: document.getElementById("unitF"),
      unitC: document.getElementById("unitC"),
      bigWord: document.getElementById("bigWord"),
      oneLiner: document.getElementById("oneLiner"),
      toast: document.getElementById("toast"),
      runSelect: document.getElementById("runSelect"),
      manualInput: document.getElementById("manualInput"),
      locList: document.getElementById("locList"),
      spinBtn: document.getElementById("spinBtn"),
      gpsBtn: document.getElementById("gpsBtn"),
      brandHome: document.getElementById("brandHome"),
      locLine: document.getElementById("locLine"),
      locSource: document.getElementById("locSource"),
      tempLine: document.getElementById("tempLine"),
      feelWindLine: document.getElementById("feelWindLine"),
      unitsFooter: document.getElementById("unitsFooter"),
      usingLine: document.getElementById("usingLine"),
      usingLoc: document.getElementById("usingLoc"),
      usingUnits: document.getElementById("usingUnits"),
      actionsLine: document.getElementById("actionsLine"),
      modalBackdrop: document.getElementById("modalBackdrop"),
      modal: document.getElementById("modal"),
      modalContent: document.getElementById("modalContent"),
      shareTakeBtn: document.getElementById("shareTakeBtn"),
      closeModalBtn: document.getElementById("closeModalBtn"),
      forecastList: document.getElementById("forecastList"),
      supportBtn: document.getElementById("supportBtn"),
      detailsDrawer: document.getElementById("detailsDrawer"),
      drawerTitle: document.getElementById("drawerTitle"),
      drawerMeta: document.getElementById("drawerMeta"),
      drawerContent: document.getElementById("drawerContent"),
      drawerSpark: document.getElementById("drawerSpark"),
      drawerClose: document.getElementById("drawerClose")
    };

    // ---------- Toast ----------
    function showToast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.toast.classList.remove("show"), 2600);
    }

    // ---------- Utils ----------
    function countryUsesF(countryCode){
      return ["US","LR","MM"].includes(String(countryCode||"").toUpperCase());
    }
    function runOffset(run){
      if (run === "cold") return -4;
      if (run === "hot") return 4;
      return 0;
    }
    function toF(c){ return (c * 9/5) + 32; }
    function toC(f){ return (f - 32) * 5/9; }
    function fmtTemp(val, units){ if (!Number.isFinite(val)) return "--"; return Math.round(val) + "Â°" + units; }
    function fmtWind(val, units){ if (!Number.isFinite(val)) return "--"; return Math.round(val) + (units === "F" ? " mph" : " km/h"); }
    function escapeHtml(str){ return String(str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function normalizeLabel(raw){
      if (!raw) return "Somewhere";
      return String(raw).replace(/[\u{1F4CD}\u{1F4CC}\u{1F4CD}\u{1F4CB}ðŸ“ðŸ“Œ\uFE0F]/gu, "").replace(/\s+/g," ").trim();
    }
    function displayWithPin(label){
      const clean = normalizeLabel(label);
      return "ðŸ“ " + clean;
    }

    // ---------- Network Helpers ----------
    async function fetchJson(url, timeoutMs = 12000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { signal: ctrl.signal, headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("http_" + res.status);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    // Normalize incoming API temps to Celsius for caching
    function normalizeForecastResponse(raw, unitsReturned){
      if (!raw || !raw.daily) return null;
      const d = raw.daily;
      const toCIfNeeded = (val) => {
        if (!Number.isFinite(val)) return null;
        return unitsReturned === "fahrenheit" ? toC(val) : val;
      };
      return {
        time: Array.isArray(d.time) ? d.time.slice(0,7) : [],
        temperature_2m_max_C: Array.isArray(d.temperature_2m_max) ? d.temperature_2m_max.map(v => toCIfNeeded(v)) : [],
        temperature_2m_min_C: Array.isArray(d.temperature_2m_min) ? d.temperature_2m_min.map(v => toCIfNeeded(v)) : [],
        apparent_temperature_max_C: Array.isArray(d.apparent_temperature_max) ? d.apparent_temperature_max.map(v => toCIfNeeded(v)) : [],
        apparent_temperature_min_C: Array.isArray(d.apparent_temperature_min) ? d.apparent_temperature_min.map(v => toCIfNeeded(v)) : [],
        weathercode: Array.isArray(d.weathercode) ? d.weathercode.slice(0,7) : []
      };
    }

    async function fetchWeather(lat, lon, units){
      const key = `weather:${lat.toFixed(4)},${lon.toFixed(4)}`;
      const cached = getCached(key);
      if (cached) return cached;

      const tempUnit = units === "F" ? "fahrenheit" : "celsius";
      const windUnit = units === "F" ? "mph" : "kmh";
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current=temperature_2m,apparent_temperature,wind_speed_10m&temperature_unit=${tempUnit}&windspeed_unit=${windUnit}&timezone=auto`;

      const raw = await fetchJson(url, 12000);
      const cur = raw.current || {};
      const normalized = {
        temperature_C: (units === "F" ? toC(cur.temperature_2m) : cur.temperature_2m),
        apparent_C: (units === "F" ? toC(cur.apparent_temperature) : cur.apparent_temperature),
        wind: cur.wind_speed_10m,
        fetchedAt: Date.now()
      };
      setCached(key, normalized);
      return normalized;
    }

    async function fetchForecast(lat, lon, units){
      const key = `forecast:${lat.toFixed(4)},${lon.toFixed(4)}`;
      const cached = getCached(key);
      if (cached) return cached;

      const tempUnit = units === "F" ? "fahrenheit" : "celsius";
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,weathercode&temperature_unit=${tempUnit}&timezone=auto&forecast_days=7`;

      const raw = await fetchJson(url, 12000);
      const normalized = normalizeForecastResponse(raw, tempUnit);
      if (!normalized) throw new Error("invalid_forecast");
      setCached(key, normalized);
      return normalized;
    }

    async function reverseGeocode(lat, lon){
      const key = `geocode:${lat.toFixed(4)},${lon.toFixed(4)}`;
      const cached = getCached(key);
      if (cached) return cached;
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&addressdetails=1&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const raw = await fetchJson(url, 12000);
      setCached(key, raw);
      return raw;
    }

    async function geocodeDisplayName(displayName){
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=1&q=${encodeURIComponent(displayName)}`;
      const data = await fetchJson(url, 12000);
      if (!data || !data[0]) throw new Error("no_results");
      const item = data[0];
      const cc = item.address && item.address.country_code ? String(item.address.country_code).toUpperCase() : null;
      const a = item.address || {};
      let label = item.display_name ? item.display_name.split(",").slice(0,2).join(",").trim() : displayName;
      
      // Better formatting
      const city = a.city || a.town || a.village || a.hamlet || a.county || a.state || "";
      if (cc === "US"){
        const st = a.state_code || a.state || "";
        if (city && st) label = city + ", " + st;
      } else if (city && a.country){
        label = city + ", " + a.country;
      }

      return { lat: parseFloat(item.lat), lon: parseFloat(item.lon), label: normalizeLabel(label), countryCode: cc };
    }

    // ---------- Snark Dictionary ----------
    const SNARK = {
      deepFreeze: ["That air hurts your face. Respectfully, no.", "If your breath is crunchy, it is coat season.", "Hoodie? Sure. Under the parka.", "The wind is auditioning to be your enemy.", "This is not hoodie weather. This is survival gear weather.", "No. Put on something that apologizes for itself.", "Only a furnace would consider this a hoodie day."],
      veryCold: ["Hoodie alone is cute. So is hypothermia.", "Nah. Add a real jacket and stop pretending.", "This is the part where you learn about wind chill.", "Hoodie? Maybe as a middle layer under a coat.", "Cold enough to make your coffee shiver."],
      cold: ["Hoodie plus a jacket. Do not get cocky.", "Layer up. Hoodie needs a bodyguard today.", "Hoodie is allowed, but bring backup.", "Perfect hoodie plus scarf weather, in my opinion.", "Wrap up â€” the hoodie wants friends (like gloves)."],
      prime: ["Prime hoodie weather. Enjoy your moment.", "This is the whole point of hoodies existing.", "Hoodie time. No notes.", "This is hoodie-peak â€” go be iconic.", "Ideal hoodie temperature. Proceed to look casually deliberate."],
      mild: ["Hoodie if you like options. Otherwise, nah.", "This is borderline. Proceed with vibes.", "A thin hoodie works. A thick one is a mistake.", "Maybe a hoodie for morning, gone by afternoon.", "Perfect for a light hoodie or a long-sleeve shirt."],
      warm: ["You are gonna regret sleeves in 10 minutes.", "Nah. Let your arms experience freedom.", "It is warm. Stop lying to yourself.", "Too warm for a hoodie unless you're insecure about sunshine.", "Wear a hoodie and you will pay for it in sweat."],
      hot: ["It is basically a warm hug from the sun. No hoodie.", "Nah. Hydrate and stop layering like a villain.", "This is not a hoodie day. This is a regret day.", "Hoodie? Only if you're trying to escape the sun by staying inside.", "Tropical hoodie remorse incoming."]
    };

    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function decide(tempF, feelsF, run){
      const t = (Number.isFinite(feelsF) ? feelsF : tempF) + runOffset(run);
      if (t <= 20) return { word: "NAH", line: pick(SNARK.deepFreeze) };
      if (t <= 35) return { word: "NAH", line: pick(SNARK.veryCold) };
      if (t <= 45) return { word: "MAYBE", line: pick(SNARK.cold) };
      if (t <= 60) return { word: "HOODIE", line: pick(SNARK.prime) };
      if (t <= 70) return { word: "MAYBE", line: pick(SNARK.mild) };
      if (t <= 82) return { word: "NAH", line: pick(SNARK.warm) };
      return { word: "NAH", line: pick(SNARK.hot) };
    }

    // ---------- SVG Icons ----------
    function svgFor(code){
      if (code == null) return { svg: `<span aria-hidden="true">â€”</span>`, text: "Unknown" };
      if (code === 0) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="currentColor" /></svg>`, text: "Clear" };
      if (code === 1 || code === 2 || code === 3) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path d="M3 15a4 4 0 0 1 4-4h8a3 3 0 0 1 0 6H7a4 4 0 0 1-4-2z" fill="currentColor"/></svg>`, text: "Cloudy" };
      if (code === 45 || code === 48) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path d="M4 12h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`, text: "Fog" };
      if (code >= 51 && code <= 67) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path d="M6 14a6 6 0 0 1 12 0" fill="currentColor"/><path d="M8 18l1.5-2" stroke="#000" stroke-width="1.4" stroke-linecap="round"/></svg>`, text: "Rain" };
      if (code >= 71 && code <= 86) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path d="M6 14a6 6 0 0 1 12 0" fill="currentColor"/><path d="M9 17l-1 2" stroke="#000" stroke-width="1.4" stroke-linecap="round"/></svg>`, text: "Snow" };
      if (code >= 95 && code <= 99) return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path d="M7 13l5-8 2 5 3-1-2 5" fill="currentColor"/></svg>`, text: "Thunder" };
      return { svg: `<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>`, text: "Weather" };
    }

    // ---------- City Pool ----------
    const CURATED_CITIES = [
      { lat:36.1699, lon:-115.1398, cc:"US", label:"Las Vegas, NV" },
      { lat:41.8781, lon:-87.6298, cc:"US", label:"Chicago, IL" },
      { lat:40.7128, lon:-74.0060, cc:"US", label:"New York, NY" },
      { lat:51.5072, lon:-0.1276, cc:"GB", label:"London, UK" },
      { lat:35.6762, lon:139.6503, cc:"JP", label:"Tokyo, Japan" },
      { lat:-33.8688, lon:151.2093, cc:"AU", label:"Sydney, Australia" },
      { lat:48.8566, lon:2.3522, cc:"FR", label:"Paris, France" },
      { lat:64.1265, lon:-21.8174, cc:"IS", label:"ReykjavÃ­k, Iceland" },
      { lat:30.0444, lon:31.2357, cc:"EG", label:"Cairo, Egypt" }
    ];

    function shuffledIndices(n){
      const a = Array.from({length:n}, (_,i)=>i);
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function loadSpinPool(){
      try{
        const raw = localStorage.getItem(SPIN_POOL_KEY);
        if (!raw) return shuffledIndices(CURATED_CITIES.length);
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length !== CURATED_CITIES.length) return shuffledIndices(CURATED_CITIES.length);
        return parsed;
      }catch(e){ return shuffledIndices(CURATED_CITIES.length); }
    }
    function saveSpinPool(pool){ try{ localStorage.setItem(SPIN_POOL_KEY, JSON.stringify(pool)); }catch(e){} }
    let spinPool = loadSpinPool();

    function popNextSpinIndex(){
      if (!Array.isArray(spinPool) || spinPool.length === 0) spinPool = shuffledIndices(CURATED_CITIES.length);
      const idx = spinPool.shift();
      saveSpinPool(spinPool);
      return idx;
    }

    // ---------- UI Updates ----------
    let loading = false;
    function setPill(rawText){
      const clean = normalizeLabel(rawText || state.placeLabel || "Somewhere");
      state.placeLabel = clean;
      el.whereText.textContent = displayWithPin(clean);
      el.wherePill.setAttribute('title', clean);
      adjustPillWidth();
      updateSourceUI();
      saveState();
    }

    function adjustPillWidth(){
      try{
        const headerRect = el.header.getBoundingClientRect();
        const brandRect = el.brand.getBoundingClientRect();
        const unitsRect = document.querySelector('.units-seg').getBoundingClientRect();
        const reserved = 36;
        const available = Math.max(120, headerRect.width - brandRect.width - unitsRect.width - reserved);
        el.wherePill.style.maxWidth = (available) + "px";
      }catch(e){}
    }

    function setLoadingUI(){
      loading = true;
      el.spinBtn.disabled = true; el.gpsBtn.disabled = true; el.manualInput.disabled = true;
      el.bigWord.classList.add("fade");
      setTimeout(()=>el.bigWord.classList.remove("fade"), 20);
      el.bigWord.textContent = "LOADING";
      el.oneLiner.textContent = "Grabbing your weather. Try not to panic.";
      el.tempLine.textContent = "--";
      el.feelWindLine.textContent = "Feels like: --  |  Wind: --";
      el.unitsFooter.textContent = "Units: --";
      el.forecastList.innerHTML = "";
      closeDrawer();
    }

    function endLoadingUI(){
      loading = false;
      el.spinBtn.disabled = false; el.gpsBtn.disabled = false; el.manualInput.disabled = false;
    }

    function updateSourceUI(){
      const sourceName = state.source === "gps" ? "GPS" : state.source === "manual" ? "Manual" : state.source === "globe" ? "Globe" : "Auto";
      el.usingLine.textContent = sourceName;
      el.usingLoc.textContent = displayWithPin(state.placeLabel || "Somewhere");
      el.usingUnits.textContent = (state.unitOverride ? (state.unitOverride === "F" ? "Fahrenheit (forced)" : "Celsius (forced)") : (state.units === "F" ? "Fahrenheit" : "Celsius"));
      if(el.actionsLine) el.actionsLine.textContent = "Click the location for details or copy";
      
      el.locLine.textContent = displayWithPin(state.placeLabel || "Somewhere");
      el.locSource.textContent = "Source: " + sourceName + ".";
      el.unitsFooter.textContent = "Units: " + (state.unitOverride ? (state.unitOverride === "F" ? "Fahrenheit (forced)" : "Celsius (forced)") : (state.units === "F" ? "Fahrenheit" : "Celsius"));
    }

    function renderResultFromNormalized(normalized){
      const tempC = normalized.temperature_C;
      const feelsC = normalized.apparent_C;
      const wind = normalized.wind;
      const tempF = Number.isFinite(tempC) ? toF(tempC) : null;
      const feelsF = Number.isFinite(feelsC) ? toF(feelsC) : null;

      const d = decide(tempF, feelsF, state.run);
      state.lastDecision = { word: d.word, line: d.line };
      el.bigWord.textContent = d.word;
      el.oneLiner.textContent = d.line;

      const displayUnits = state.unitOverride || state.units;
      const displayTemp = displayUnits === "F" ? (Number.isFinite(tempC) ? Math.round(toF(tempC)) : null) : tempC;
      const displayFeels = displayUnits === "F" ? (Number.isFinite(feelsC) ? Math.round(toF(feelsC)) : null) : feelsC;

      el.tempLine.textContent = fmtTemp(displayTemp, displayUnits);
      el.feelWindLine.textContent = "Feels like: " + fmtTemp(displayFeels, displayUnits) + "  |  Wind: " + fmtWind(wind, displayUnits);

      updateSourceUI();
      saveState();
    }

    // ---------- Forecast Render ----------
    function renderForecast(normalized){
      if (!normalized || !Array.isArray(normalized.time)) {
        el.forecastList.innerHTML = "";
        return;
      }
      const days = Math.min(5, normalized.time.length);
      const frag = document.createDocumentFragment();
      const metaList = [];

      for (let i = 0; i < days; i++){
        const dateStr = normalized.time[i];
        const tmaxC = Number.isFinite(normalized.temperature_2m_max_C[i]) ? normalized.temperature_2m_max_C[i] : null;
        const tminC = Number.isFinite(normalized.temperature_2m_min_C[i]) ? normalized.temperature_2m_min_C[i] : null;
        
        let avgFeelsC = tmaxC; // simplify for list view
        const tempF_forDecision = Number.isFinite(avgFeelsC) ? toF(avgFeelsC) : null;
        const dec = decide(tempF_forDecision, tempF_forDecision, state.run);

        const dayLabel = (function(d){
          try{ return new Date(d + "T00:00:00").toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" }); }catch(e){ return d; }
        })(dateStr);

        const displayUnits = state.unitOverride || state.units;
        const displayMax = Number.isFinite(tmaxC) ? (displayUnits === "F" ? Math.round(toF(tmaxC)) : Math.round(tmaxC)) : null;
        const displayMin = Number.isFinite(tminC) ? (displayUnits === "F" ? Math.round(toF(tminC)) : Math.round(tminC)) : null;

        const weatherCode = (Array.isArray(normalized.weathercode) && normalized.weathercode[i] != null) ? normalized.weathercode[i] : null;
        const icon = svgFor(weatherCode);

        const elCard = document.createElement('div');
        elCard.className = 'forecast-item';
        elCard.setAttribute('role','button');
        elCard.setAttribute('tabindex','0');
        elCard.setAttribute('aria-label', dayLabel);
        elCard.innerHTML = `
          <div class="row">
            <div class="icon" aria-hidden="true">${icon.svg}</div>
            <div class="day">${escapeHtml(dayLabel)}</div>
          </div>
          <div class="temp">${escapeHtml(displayMax != null ? (displayMax + "Â°" + displayUnits) : "--")} / ${escapeHtml(displayMin != null ? (displayMin + "Â°" + displayUnits) : "--")}</div>
          <div class="verdict">${escapeHtml(dec.word)}</div>
          <div class="snark">${escapeHtml(dec.line)}</div>
        `;
        frag.appendChild(elCard);
        metaList.push({ dateStr, dayLabel, tmaxC, tminC, dec, weatherCode });
      }
      el.forecastList.innerHTML = "";
      el.forecastList.appendChild(frag);
      Array.from(el.forecastList.children).forEach((child, idx) => { child._meta = metaList[idx]; });
    }

    // ---------- Drawer & Interactions ----------
    function openDrawer(){ el.detailsDrawer.setAttribute('aria-hidden', 'false'); }
    function closeDrawer(){
      el.detailsDrawer.setAttribute('aria-hidden', 'true');
      el.drawerTitle.textContent = "Select a day for details";
      el.drawerMeta.textContent = "No day selected.";
      el.drawerContent.innerHTML = "";
      el.drawerSpark.innerHTML = "";
    }

    function renderSparkline(values){
      const svg = el.drawerSpark;
      if (!Array.isArray(values) || values.length === 0) { svg.innerHTML = ""; return; }
      const w = 200, h = 48, pad = 6;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;
      const points = values.map((v, i) => {
        const x = pad + (i * (w - pad * 2) / (values.length - 1));
        const y = pad + (1 - ((v - min) / range)) * (h - pad * 2);
        return [x,y];
      });
      const path = points.map((p,i)=> (i===0?`M ${p[0]} ${p[1]}`: `L ${p[0]} ${p[1]}`)).join(' ');
      const circles = points.map(p => `<circle cx="${p[0]}" cy="${p[1]}" r="1.2" fill="currentColor" />`).join('');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.innerHTML = `<path d="${path}" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"></path>${circles}`;
    }

    function showDayInDrawer(meta){
      if (!meta) return;
      openDrawer();
      el.drawerTitle.textContent = meta.dayLabel;
      const displayUnits = state.unitOverride || state.units;
      const maxDisplay = Number.isFinite(meta.tmaxC) ? (displayUnits === "F" ? Math.round(toF(meta.tmaxC)) : Math.round(meta.tmaxC)) : null;
      const minDisplay = Number.isFinite(meta.tminC) ? (displayUnits === "F" ? Math.round(toF(meta.tminC)) : Math.round(meta.tminC)) : null;
      const icon = svgFor(meta.weatherCode);
      el.drawerMeta.innerHTML = `${icon.svg} <span style="margin-left:8px;font-weight:700;color:var(--text)">${escapeHtml(icon.text)}</span>`;
      el.drawerContent.innerHTML = `
        <div style="margin-top:6px;">
          <div style="font-weight:800;color:var(--text)">Temps: ${escapeHtml(maxDisplay != null ? (maxDisplay + "Â°" + displayUnits) : "--")} / ${escapeHtml(minDisplay != null ? (minDisplay + "Â°" + displayUnits) : "--")}</div>
          <div style="margin-top:6px;color:var(--muted)">${escapeHtml(meta.dec.word)}</div>
          <div style="margin-top:6px;color:var(--muted2)">${escapeHtml(meta.dec.line)}</div>
        </div>
      `;
      const fkey = state.lat && state.lon ? `forecast:${state.lat.toFixed(4)},${state.lon.toFixed(4)}` : null;
      const forecast = fkey ? getCached(fkey) : null;
      if (forecast && Array.isArray(forecast.temperature_2m_max_C)){
        renderSparkline(forecast.temperature_2m_max_C.slice(0,5));
      } else { renderSparkline([meta.tmaxC||0]); }
    }

    async function updateWeatherFromLatLon(lat, lon, label, countryCode, source){
      state.lat = lat; state.lon = lon; state.source = source || state.source;
      const effectiveUnits = state.unitOverride ? state.unitOverride : (countryCode ? (countryUsesF(countryCode) ? "F" : "C") : state.units);
      state.units = effectiveUnits;
      state.placeLabel = normalizeLabel(label || state.placeLabel || formatLatLonFallback(lat, lon));
      state.countryCode = countryCode || state.countryCode;
      setPill(state.placeLabel);
      setLoadingUI();
      try{
        const curNorm = await fetchWeather(lat, lon, state.units);
        renderResultFromNormalized(curNorm);
      }catch(e){
        console.error(e);
        el.bigWord.textContent = "MAYBE";
        el.oneLiner.textContent = "Weather fetch failed.";
        showToast("Could not fetch weather. Try again.");
      }finally{
        try{
          const forecastNorm = await fetchForecast(lat, lon, state.units);
          renderForecast(forecastNorm);
        }catch(fe){ renderForecast(null); }
        endLoadingUI();
        saveState();
      }
    }

    function formatLatLonFallback(lat, lon){ return (!Number.isFinite(lat) || !Number.isFinite(lon)) ? "Somewhere" : lat.toFixed(2) + "Â°, " + lon.toFixed(2) + "Â°"; }

    // ---------- GPS / Auto ----------
    async function tryAutoLocation(){
      state.source = "auto"; state.placeLabel = "Near you";
      setPill("Near you"); updateSourceUI(); setLoadingUI();

      if (!navigator.geolocation){
        el.bigWord.textContent = "MAYBE"; el.oneLiner.textContent = "No GPS here. Type a city."; endLoadingUI(); return;
      }
      setPill("Locating...");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        await updateWeatherFromLatLon(lat, lon, "Near you", null, "gps");
        try{
          const rev = await reverseGeocode(lat, lon);
          if (rev && rev.display_name){
            const cc = rev.address && rev.address.country_code ? String(rev.address.country_code).toUpperCase() : null;
            state.countryCode = cc || state.countryCode;
            const label = rev.display_name.split(",").slice(0,2).join(",").trim();
            state.placeLabel = normalizeLabel(label);
            setPill(state.placeLabel);
            updateSourceUI();
          }
        }catch(err){}
      }, (err) => {
        setPill("Near you"); el.bigWord.textContent = "MAYBE"; el.oneLiner.textContent = "Location failed. Type a place.";
        showToast("GPS timeout or denied"); endLoadingUI();
      }, { enableHighAccuracy: false, timeout: 8000 });
    }

    async function onUseGPS(){
      if (!navigator.geolocation){ showToast("No GPS available."); return; }
      state.source = "gps"; updateSourceUI(); setPill("Locating..."); setLoadingUI();
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        await updateWeatherFromLatLon(lat, lon, "Near you", null, "gps");
        try{
          const rev = await reverseGeocode(lat, lon);
          if (rev && rev.display_name){
            const cc = rev.address && rev.address.country_code ? String(rev.address.country_code).toUpperCase() : null;
            state.countryCode = cc || state.countryCode;
            const label = rev.display_name.split(",").slice(0,2).join(",").trim();
            state.placeLabel = normalizeLabel(label);
            setPill(state.placeLabel);
            updateSourceUI();
          }
        }catch(err){}
      }, (err) => {
        setPill("Near you"); el.bigWord.textContent = "MAYBE"; el.oneLiner.textContent = "Location failed.";
        showToast("GPS error"); endLoadingUI();
      }, { enableHighAccuracy: true, timeout: 9000 });
    }

    // ---------- Manual / Spin ----------
    async function onSpinGlobe(){
      state.source = "globe"; updateSourceUI(); setPill("Spinning..."); setLoadingUI();
      await sleep(320);
      const idx = popNextSpinIndex();
      const pick = CURATED_CITIES[idx];
      state.placeLabel = normalizeLabel(pick.label);
      state.countryCode = pick.cc;
      if(!state.unitOverride) state.units = countryUsesF(state.countryCode) ? "F" : "C";
      setPill(state.placeLabel);
      await updateWeatherFromLatLon(pick.lat, pick.lon, state.placeLabel, pick.cc, "globe");
    }

    let suggestTimer = null;
    el.manualInput.addEventListener('input', () => {
      const val = (el.manualInput.value||"").trim();
      if(val.length < 3) { el.locList.innerHTML = ""; return; }
      clearTimeout(suggestTimer);
      suggestTimer = setTimeout(async ()=>{
        try{
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=5&q=${encodeURIComponent(val)}`);
          if(!res.ok) return;
          const data = await res.json();
          el.locList.innerHTML = (data||[]).map(item => `<option value="${escapeHtml(item.display_name)}"></option>`).join("");
        }catch(e){}
      }, 300);
      const opts = Array.from(el.locList.options || []).map(o => o.value);
      if (opts.includes(val)) setTimeout(() => { if (!loading) onManualSubmit(); }, 6);
    });

    async function onManualSubmit(){
      const q = (el.manualInput.value || "").trim();
      if (!q){ showToast("Type a place first."); return; }
      state.source = "manual"; updateSourceUI(); setPill("Searching..."); setLoadingUI();
      try{
        const g = await geocodeDisplayName(q);
        await updateWeatherFromLatLon(g.lat, g.lon, g.label, g.countryCode, "manual");
      }catch(e){
        el.bigWord.textContent = "MAYBE"; el.oneLiner.textContent = "Could not find that place.";
        showToast("No results found."); setPill("Near you"); endLoadingUI();
      }
    }

    // ---------- Modal / Share ----------
    function openModal(titleHtml){ el.modalBackdrop.style.display = "flex"; el.modalBackdrop.setAttribute("aria-hidden", "false"); el.modalContent.innerHTML = titleHtml; }
    function closeModal(){ el.modalBackdrop.style.display = "none"; el.modalBackdrop.setAttribute("aria-hidden", "true"); }
    el.wherePill.addEventListener("click", async ()=>{
      const full = state.placeLabel || "Somewhere";
      const html = `<div><strong>${escapeHtml(displayWithPin(full))}</strong><pre style="margin-top:8px;">${escapeHtml(state.lastDecision.word || "")} â€” ${escapeHtml(state.placeLabel || "")}\n${el.tempLine.textContent || ""}\n${el.oneLiner.textContent || ""}</pre></div>`;
      openModal(html);
    });
    el.shareTakeBtn.addEventListener("click", async ()=>{
      const shareText = `${state.lastDecision.word || "MAYBE"} â€” ${state.placeLabel || ""} â€” ${el.tempLine.textContent || ""} â€” ${el.oneLiner.textContent || ""} â€” #HoodieOrNah`;
      try{ await navigator.clipboard.writeText(shareText); showToast("Copied to clipboard"); }catch(e){ showToast("Copy failed"); }
    });
    el.closeModalBtn.addEventListener("click", closeModal);
    el.modalBackdrop.addEventListener("click", (e)=>{ if (e.target === el.modalBackdrop) closeModal(); });

    // ---------- Event Listeners ----------
    el.forecastList.addEventListener('click', (ev) => { const item = ev.target.closest('.forecast-item'); if(item) showDayInDrawer(item._meta); });
    el.drawerClose.addEventListener('click', closeDrawer);
    el.manualInput.addEventListener('keydown', (e) => { if (e.key === "Enter"){ e.preventDefault(); onManualSubmit(); } });
    el.spinBtn.addEventListener("click", onSpinGlobe);
    el.gpsBtn.addEventListener("click", onUseGPS);
    el.brandHome.addEventListener("click", () => { el.manualInput.value = ""; tryAutoLocation(); });
    
    function applyUnitSelection(newSel){
      state.unitOverride = newSel;
      if (state.unitOverride) state.units = state.unitOverride;
      else state.units = state.countryCode ? (countryUsesF(state.countryCode) ? "F" : "C") : state.units;
      setUnitControlButtons(); saveState();
      if (Number.isFinite(state.lat)) updateWeatherFromLatLon(state.lat, state.lon, state.placeLabel, state.countryCode, state.source);
    }
    function setUnitControlButtons(){
      el.unitAuto.setAttribute("aria-pressed", String(!state.unitOverride));
      el.unitF.setAttribute("aria-pressed", String(state.unitOverride === "F"));
      el.unitC.setAttribute("aria-pressed", String(state.unitOverride === "C"));
    }
    el.unitAuto.addEventListener("click", () => applyUnitSelection(null));
    el.unitF.addEventListener("click", () => applyUnitSelection("F"));
    el.unitC.addEventListener("click", () => applyUnitSelection("C"));

    el.runSelect.value = state.run || "normal";
    el.runSelect.addEventListener("change", () => {
      state.run = el.runSelect.value; saveState();
      if(Number.isFinite(state.lat)) updateWeatherFromLatLon(state.lat, state.lon, state.placeLabel, state.countryCode, state.source);
    });

    // ---------- Init ----------
    function init(){
      setUnitControlButtons(); setPill(state.placeLabel || "Near you"); updateSourceUI();
      if (Number.isFinite(state.lat) && Number.isFinite(state.lon)){
        updateWeatherFromLatLon(state.lat, state.lon, state.placeLabel, state.countryCode, state.source);
      } else { tryAutoLocation(); }
      adjustPillWidth(); window.addEventListener("resize", adjustPillWidth);
    }
    init();
  </script>
</body>
</html>
