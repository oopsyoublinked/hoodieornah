<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie, maybe, or nah based on your local weather." />
  <meta name="theme-color" content="#0b0b0f" />

  <!-- Favicons / App Icons -->
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="/favicon-32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/favicon-16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
  <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192" />
  <link rel="icon" type="image/png" href="/android-chrome-512x512.png" sizes="512x512" />

  <!-- Open Graph -->
  <meta property="og:title" content="Hoodie or Nah" />
  <meta property="og:description" content="Settle the hoodie debate in one click. Hoodie, maybe, or nah based on your local weather." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://hoodieornah.com" />
  <meta property="og:image" content="https://hoodieornah.com/og.png" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Hoodie or Nah" />
  <meta name="twitter:description" content="Hoodie, maybe, or nah. Based on your weather." />
  <meta name="twitter:image" content="https://hoodieornah.com/og.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#0f1016;
      --panel2:#0d0e14;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.48);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:22px;
      --radius2:28px;
      --glow: 0 0 0 1px rgba(255,255,255,.06), 0 0 24px rgba(120,160,255,.10);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(120,160,255,.12), transparent 45%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.06), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 18px 28px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      backdrop-filter: blur(10px);
      z-index: 5;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
    }

    .brand-btn{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.10), rgba(255,255,255,.02));
      display:grid;
      place-items:center;
      padding:0;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      box-shadow: 0 8px 28px rgba(0,0,0,.45);
    }
    .brand-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(140,170,255,.35);
      box-shadow: 0 10px 34px rgba(0,0,0,.55), 0 0 26px rgba(120,160,255,.14);
    }
    .brand-btn:active{transform: translateY(0px) scale(.99)}
    .brand-btn svg{
      width: 28px;
      height: 28px;
      display:block;
      opacity:.92;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.45));
    }

    .wordmark{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      min-width:0;
    }
    .wordmark .title{
      font-size: 22px;
      font-weight: 780;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .wordmark .tag{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: .2px;
      margin-top: 3px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight: 650;
      letter-spacing: .2px;
      user-select:none;
      max-width: 46%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .pill .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.32);
      box-shadow: 0 0 0 4px rgba(255,255,255,.04);
      flex: 0 0 auto;
    }

    .spinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.24);
      border-top-color: rgba(255,255,255,.82);
      animation: spin .75s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    main{
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .pill{max-width: 60%}
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--border2);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(120,160,255,.10), transparent 42%),
        radial-gradient(700px 420px at 85% 10%, rgba(255,255,255,.07), transparent 50%),
        rgba(0,0,0,.22);
      padding: 18px;
      min-height: 420px;
      position:relative;
      overflow:hidden;
    }

    .card-right{
      border-radius: var(--radius);
      border: 1px solid var(--border2);
      background: rgba(0,0,0,.18);
      padding: 18px;
      min-height: 420px;
    }

    .big{
      font-size: 86px;
      font-weight: 900;
      letter-spacing: .6px;
      margin: 8px 0 6px;
    }
    @media (max-width: 560px){
      .big{font-size: 56px}
    }
    .sub{
      color: var(--muted);
      font-size: 16px;
      margin: 0 0 10px;
      max-width: 44ch;
    }

    .result-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      margin-top: 14px;
    }
    .temp{
      font-size: 42px;
      font-weight: 860;
      letter-spacing: .2px;
    }
    .meta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      text-align:right;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 16px 0 12px;
    }

    h3{
      margin: 0 0 10px;
      font-size: 22px;
      font-weight: 820;
      letter-spacing: .2px;
    }

    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 12px 0 8px;
      font-weight: 650;
    }

    select, input{
      width:100%;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline: none;
      font-size: 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    input::placeholder{color: rgba(255,255,255,.35)}

    .btn-row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    button{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 740;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }
    button:active{transform: translateY(0px) scale(.99)}
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }

    footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-top: 12px;
      color: var(--muted);
      font-weight: 650;
      padding: 6px 4px 0;
    }
    footer .support{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      text-decoration:none;
      color: var(--text);
    }
    footer .support:hover{border-color: rgba(255,255,255,.18)}
    .coin{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05);
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.75);
      color: var(--text);
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 30;
      max-width: min(640px, calc(100% - 24px));
      text-align:center;
      font-weight: 700;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .hoodie-mark{
      display:inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }

    .qmark{
      transform-origin: 50% 55%;
      animation: qpop 900ms ease-out 1;
    }
    @keyframes qpop{
      0%{transform: translateY(2px) scale(.96); opacity:.0}
      35%{transform: translateY(0px) scale(1.04); opacity:.92}
      70%{transform: translateY(0px) scale(1.0); opacity:1}
      100%{transform: translateY(0px) scale(1.0); opacity:1}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <button class="brand-btn" id="brandHome" aria-label="Hoodie or Nah home">
          <!-- Clean, sharp hoodie mark -->
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <path d="M22 20c2-7 8-11 10-11s8 4 10 11" stroke="rgba(255,255,255,.88)" stroke-width="3.5" stroke-linecap="round"/>
            <path d="M16 28c3-5 7-8 16-8s13 3 16 8" stroke="rgba(255,255,255,.78)" stroke-width="3.5" stroke-linecap="round"/>
            <path d="M16 28v18c0 6 7 10 16 10s16-4 16-10V28" stroke="rgba(255,255,255,.70)" stroke-width="3.5" stroke-linecap="round"/>
            <path class="qmark" d="M34.5 30.8c0-2.1-1.6-3.6-3.8-3.6-1.5 0-2.7.6-3.6 1.8" stroke="rgba(255,255,255,.92)" stroke-width="3.2" stroke-linecap="round"/>
            <path class="qmark" d="M29.8 40.2v.2" stroke="rgba(255,255,255,.92)" stroke-width="5.2" stroke-linecap="round"/>
            <path class="qmark" d="M30.3 33.2c1.9 0 3.1 1 3.1 2.6 0 1.3-.7 2-1.7 2.6-.7.4-1.1.8-1.1 1.5" stroke="rgba(255,255,255,.92)" stroke-width="3.2" stroke-linecap="round"/>
          </svg>
        </button>

        <div class="wordmark">
          <div class="title">Hoodie or Nah</div>
          <div class="tag">Hoodie judgment, delivered.</div>
        </div>
      </div>

      <div class="pill" id="wherePill" title="Location">
        <span class="dot" aria-hidden="true"></span>
        <span id="whereText">Near you</span>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- Left: Result -->
        <section class="card" aria-live="polite">
          <div class="big" id="bigWord">LOADING</div>
          <p class="sub" id="oneLiner">Grabbing your weather. Try not to panic.</p>

          <div class="divider"></div>

          <div class="result-row">
            <div class="temp" id="tempText">--</div>
            <div class="meta" id="metaText">
              Feels like: --<br/>
              Wind: --<br/>
              Units: --
            </div>
          </div>
        </section>

        <!-- Right: Controls -->
        <aside class="card-right">
          <h3>How do you run?</h3>
          <select id="runSelect" aria-label="How do you run">
            <option value="cold">Always cold</option>
            <option value="normal" selected>Normal</option>
            <option value="hot">Always hot</option>
          </select>

          <label for="manualInput">Manual location (optional)</label>
          <input id="manualInput" list="locList" placeholder="City, Region, Country or ZIP (example)" autocomplete="off" />
          <datalist id="locList"></datalist>

          <div class="btn-row">
            <button id="spinBtn" type="button">Spin the globe</button>
            <button id="gpsBtn" type="button">Use my GPS</button>
          </div>

          <label style="margin-top:16px;">Tip</label>
          <div style="color:var(--muted); font-size:13px; line-height:1.5;">
            Pick a vibe, type a place, or let GPS do its thing. The left panel updates when we fetch weather.
          </div>
        </aside>
      </div>

      <footer>
        <a class="support" href="https://www.buymeacoffee.com/" target="_blank" rel="noopener">
          <span>Support the hoodie science</span>
          <span class="coin" aria-hidden="true"></span>
        </a>
        <div>Hoodie judgment, delivered.</div>
      </footer>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    const state = {
      run: "normal",
      source: "auto", // auto | gps | manual | globe
      placeLabel: "Near you",
      lat: null,
      lon: null,
      countryCode: null,
      isLoading: true,
      units: "F"
    };

    // -----------------------------
    // DOM
    // -----------------------------
    const wherePill = document.getElementById("wherePill");
    const whereText = document.getElementById("whereText");
    const bigWord = document.getElementById("bigWord");
    const oneLiner = document.getElementById("oneLiner");
    const tempText = document.getElementById("tempText");
    const metaText = document.getElementById("metaText");
    const toastEl = document.getElementById("toast");

    const runSelect = document.getElementById("runSelect");
    const manualInput = document.getElementById("manualInput");
    const locList = document.getElementById("locList");
    const spinBtn = document.getElementById("spinBtn");
    const gpsBtn = document.getElementById("gpsBtn");
    const brandHome = document.getElementById("brandHome");

    // -----------------------------
    // Helpers
    // -----------------------------
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    function setPill(text, { loading=false } = {}){
      if (loading){
        wherePill.innerHTML = '<span class="spinner" aria-hidden="true"></span><span id="whereText">Locating...</span>';
        return;
      }
      wherePill.innerHTML = '<span class="dot" aria-hidden="true"></span><span id="whereText"></span>';
      document.getElementById("whereText").textContent = text;
    }

    function countryUsesF(countryCode){
      // Fahrenheit countries: US, Liberia, Myanmar
      return ["US", "LR", "MM"].includes((countryCode || "").toUpperCase());
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function runOffset(run){
      // Cold people need warmer threshold, hot people need cooler threshold
      if (run === "cold") return -4;  // feels colder, so recommend more layers sooner
      if (run === "hot") return +4;   // feels warmer, so recommend fewer layers
      return 0;
    }

    function decide(tempF, feelsF, run){
      // Use feels-like as the real decider if we have it
      const t = (Number.isFinite(feelsF) ? feelsF : tempF) + runOffset(run);

      // These are intentionally conservative so 25F is never "hoodie sweetspot"
      if (t <= 25) return { word: "NAH", line: "That air hurts your face. Bundle up.", note: "Heavy coat recommended." };
      if (t <= 35) return { word: "NAH", line: "Hoodie alone is cute. So is hypothermia.", note: "Coat or layered hoodie." };
      if (t <= 45) return { word: "MAYBE", line: "Hoodie plus a jacket. Donâ€™t get cocky.", note: "Light jacket over hoodie." };
      if (t <= 60) return { word: "HOODIE", line: "This is prime hoodie weather. Enjoy your moment.", note: "Hoodie is perfect." };
      if (t <= 70) return { word: "MAYBE", line: "Hoodie if you like options. Otherwise, nah.", note: "Light layer optional." };
      if (t <= 82) return { word: "NAH", line: "Youâ€™re gonna regret sleeves in 10 minutes.", note: "T-shirt weather." };
      return { word: "NAH", line: "Itâ€™s basically a warm hug from the sun. No hoodie.", note: "Stay cool." };
    }

    function fmtTemp(val, units){
      if (!Number.isFinite(val)) return "--";
      return Math.round(val) + "Â°" + units;
    }

    function fmtWind(ms, units){
      if (!Number.isFinite(ms)) return "--";
      // Open-Meteo gives windspeed in km/h if requested, but we will request mph for F and km/h for C.
      return Math.round(ms) + (units === "F" ? " mph" : " km/h");
    }

    function setLoading(on){
      state.isLoading = on;
      if (on){
        bigWord.textContent = "LOADING";
        oneLiner.textContent = "Grabbing your weather. Try not to panic.";
        tempText.textContent = "--";
        metaText.innerHTML = "Feels like: --<br/>Wind: --<br/>Units: --";
      }
    }

    // -----------------------------
    // Geocoding (Nominatim)
    // -----------------------------
    let suggestAbort = null;

    async function suggestLocations(q){
      if (!q || q.trim().length < 3){
        locList.innerHTML = "";
        return;
      }
      if (suggestAbort) suggestAbort.abort();
      suggestAbort = new AbortController();

      const url = "https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q=" + encodeURIComponent(q);
      const res = await fetch(url, {
        signal: suggestAbort.signal,
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) return;

      const data = await res.json();
      locList.innerHTML = data.map(item => {
        const label = item.display_name;
        // Store lat/lon on option via value only, we resolve again on submit
        return '<option value="' + escapeHtml(label) + '"></option>';
      }).join("");
    }

    async function geocodeDisplayName(displayName){
      const url = "https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=1&q=" + encodeURIComponent(displayName);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("geocode_failed");
      const data = await res.json();
      if (!data || !data[0]) throw new Error("no_results");

      const item = data[0];
      const cc = item.address && item.address.country_code ? item.address.country_code.toUpperCase() : null;

      return {
        lat: parseFloat(item.lat),
        lon: parseFloat(item.lon),
        label: simplifyLabel(item),
        countryCode: cc
      };
    }

    async function reverseGeocode(lat, lon){
      const url = "https://nominatim.openstreetmap.org/reverse?format=jsonv2&addressdetails=1&lat=" + encodeURIComponent(lat) + "&lon=" + encodeURIComponent(lon);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("reverse_failed");
      const data = await res.json();
      const cc = data.address && data.address.country_code ? data.address.country_code.toUpperCase() : null;
      return {
        label: simplifyLabel(data),
        countryCode: cc
      };
    }

    function simplifyLabel(obj){
      // Prefer "City, ST" for US, otherwise "City, Country"
      const a = obj.address || {};
      const city = a.city || a.town || a.village || a.hamlet || a.county || a.state || "";
      const state = a.state || a.region || "";
      const country = a.country || "";
      const cc = a.country_code ? a.country_code.toUpperCase() : null;

      if (cc === "US"){
        const st = a.state_code || state;
        return (city && st) ? (city + ", " + st) : (obj.display_name ? obj.display_name.split(",").slice(0,2).join(",").trim() : "Near you");
      }

      if (city && country) return city + ", " + country;
      if (obj.display_name) return obj.display_name.split(",").slice(0,2).join(",").trim();
      return "Near you";
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -----------------------------
    // Weather (Open-Meteo)
    // -----------------------------
    async function fetchWeather(lat, lon, units){
      // We request temperature_unit and windspeed_unit so we can display correctly.
      const tempUnit = units === "F" ? "fahrenheit" : "celsius";
      const windUnit = units === "F" ? "mph" : "kmh";

      const url =
        "https://api.open-meteo.com/v1/forecast" +
        "?latitude=" + encodeURIComponent(lat) +
        "&longitude=" + encodeURIComponent(lon) +
        "&current=temperature_2m,apparent_temperature,wind_speed_10m" +
        "&temperature_unit=" + tempUnit +
        "&windspeed_unit=" + windUnit +
        "&timezone=auto";

      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("weather_failed");
      return await res.json();
    }

    function toF(c){ return (c * 9/5) + 32; }

    // -----------------------------
    // Render
    // -----------------------------
    function renderResult({ temp, feels, wind, units }){
      const { word, line } = decide(
        units === "F" ? temp : toF(temp),
        units === "F" ? feels : toF(feels),
        state.run
      );

      bigWord.textContent = word;
      oneLiner.textContent = line;

      tempText.textContent = fmtTemp(temp, units);

      metaText.innerHTML =
        "Feels like: " + fmtTemp(feels, units) + "<br/>" +
        "Wind: " + fmtWind(wind, units) + "<br/>" +
        "Units: " + (units === "F" ? "Fahrenheit" : "Celsius");
    }

    // -----------------------------
    // Actions
    // -----------------------------
    async function updateWeatherFromLatLon(lat, lon, label, countryCode, source){
      state.lat = lat;
      state.lon = lon;
      state.countryCode = countryCode || state.countryCode;
      state.source = source || state.source;

      state.units = countryUsesF(state.countryCode) ? "F" : "C";

      // Pill should reflect the active location, not "Near you"
      setPill("ðŸ“ " + label);

      setLoading(true);

      try{
        const data = await fetchWeather(lat, lon, state.units);
        const cur = data.current || {};
        const temp = cur.temperature_2m;
        const feels = cur.apparent_temperature;
        const wind = cur.wind_speed_10m;

        setLoading(false);
        renderResult({ temp, feels, wind, units: state.units });
      }catch(e){
        setLoading(false);
        bigWord.textContent = "MAYBE";
        oneLiner.textContent = "Weather fetch failed. The hoodie gods are silent.";
        showToast("Could not fetch weather. Try again.");
      }
    }

    async function tryAutoLocation(){
      // Start in a sane state. Do not block the right-side controls.
      setPill("Near you");
      setLoading(true);

      // If geolocation is available, attempt it quickly, but do not stall the UI forever.
      if (!navigator.geolocation){
        setLoading(false);
        bigWord.textContent = "MAYBE";
        oneLiner.textContent = "No GPS available here. Type a city and weâ€™ll judge it anyway.";
        return;
      }

      // Show subtle spinner inside pill while browser resolves
      setPill("", { loading: true });

      const opts = { enableHighAccuracy: false, timeout: 8000, maximumAge: 120000 };

      navigator.geolocation.getCurrentPosition(async (pos) => {
        try{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const rev = await reverseGeocode(lat, lon);

          await updateWeatherFromLatLon(lat, lon, rev.label, rev.countryCode, "gps");
        }catch(err){
          setPill("Near you");
          setLoading(false);
          bigWord.textContent = "MAYBE";
          oneLiner.textContent = "Couldnâ€™t resolve your city. Type one and weâ€™ll be dramatic about it.";
          showToast("Location lookup failed");
        }
      }, (err) => {
        setPill("Near you");
        setLoading(false);
        bigWord.textContent = "MAYBE";
        oneLiner.textContent = "No location, no problem. Type a place and letâ€™s argue about hoodies.";
        if (err && err.code === 1) showToast("Location access denied");
        else showToast("GPS error or timeout");
      }, opts);
    }

    async function onUseGPS(){
      // Manual trigger
      if (!navigator.geolocation){
        showToast("No GPS available in this browser.");
        return;
      }
      setPill("", { loading: true });

      const opts = { enableHighAccuracy: true, timeout: 9000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const rev = await reverseGeocode(lat, lon);

          await updateWeatherFromLatLon(lat, lon, rev.label, rev.countryCode, "gps");
        }catch(e){
          setPill("Near you");
          showToast("Could not resolve your city");
        }
      }, (err) => {
        setPill("Near you");
        if (err && err.code === 1) showToast("Location access denied");
        else showToast("GPS error or timeout");
      }, opts);
    }

    const globeSpins = [
      { label: "ReykjavÃ­k, Iceland", lat: 64.1466, lon: -21.9426, cc:"IS" },
      { label: "London, UK", lat: 51.5072, lon: -0.1276, cc:"GB" },
      { label: "Tokyo, Japan", lat: 35.6762, lon: 139.6503, cc:"JP" },
      { label: "Sydney, Australia", lat: -33.8688, lon: 151.2093, cc:"AU" },
      { label: "Mexico City, Mexico", lat: 19.4326, lon: -99.1332, cc:"MX" },
      { label: "Toronto, Canada", lat: 43.6532, lon: -79.3832, cc:"CA" },
      { label: "Chicago, IL", lat: 41.8781, lon: -87.6298, cc:"US" },
      { label: "Las Vegas, NV", lat: 36.1699, lon: -115.1398, cc:"US" },
      { label: "Paris, France", lat: 48.8566, lon: 2.3522, cc:"FR" }
    ];

    async function onSpinGlobe(){
      const pick = globeSpins[Math.floor(Math.random() * globeSpins.length)];
      await updateWeatherFromLatLon(pick.lat, pick.lon, pick.label, pick.cc, "globe");
    }

    async function onManualCommit(){
      const q = (manualInput.value || "").trim();
      if (!q){
        showToast("Type a city or ZIP first.");
        return;
      }

      try{
        const g = await geocodeDisplayName(q);
        await updateWeatherFromLatLon(g.lat, g.lon, g.label, g.countryCode, "manual");
      }catch(e){
        showToast("No results. Try a slightly different spelling.");
      }
    }

    // -----------------------------
    // Events
    // -----------------------------
    runSelect.addEventListener("change", () => {
      state.run = runSelect.value;
      // Re-render decision immediately if we already have weather values in DOM
      // Best-effort: trigger a refresh if we have coordinates.
      if (Number.isFinite(state.lat) && Number.isFinite(state.lon)){
        // Just refetch for simplicity (also updates feels/wind)
        updateWeatherFromLatLon(state.lat, state.lon, (document.getElementById("whereText")?.textContent || state.placeLabel).replace(/^ðŸ“\s*/, ""), state.countryCode, state.source);
      }
    });

    manualInput.addEventListener("input", () => {
      suggestLocations(manualInput.value).catch(() => {});
    });

    manualInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        onManualCommit();
      }
    });

    spinBtn.addEventListener("click", onSpinGlobe);
    gpsBtn.addEventListener("click", onUseGPS);

    brandHome.addEventListener("click", () => {
      manualInput.value = "";
      locList.innerHTML = "";
      tryAutoLocation();
    });

    // -----------------------------
    // Init
    // -----------------------------
    (function init(){
      state.run = runSelect.value;
      // Light, once-only question mark animation already handled by CSS.
      // Start auto-location attempt, but never lock the UI.
      tryAutoLocation();
    })();
  </script>
</body>
</html>


