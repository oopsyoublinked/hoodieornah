<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie, maybe, or nah based on your local weather." />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  
  <style>
    :root {
      --bg: #0b0b0f;
      --panel: #0f1016;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.48);
      --shadow: 0 12px 36px rgba(0,0,0,.5);
      --radius: 16px;
      --radius2: 20px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* Baseline */
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      color: var(--text);
      background: 
        radial-gradient(1200px 600px at 10% 0%, rgba(120,160,255,.06), transparent 45%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.03), transparent 55%),
        var(--bg);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
    }
    
    a {
      color: inherit;
      text-decoration: none;
    }

    /* Container */
    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .brand-btn {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      display: grid;
      place-items: center;
      background: rgba(255,255,255,.02);
      font-size: 28px;
    }
    
    .wordmark .title {
      font-weight: 780;
      font-size: 18px;
    }
    
    .wordmark .tag {
      font-size: 11px;
      color: var(--muted2);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Fixed button/select styling */
    .btn, button {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 600;
      transition: background 0.15s ease, transform 0.1s ease;
    }
    
    .btn:hover, button:hover {
      background: rgba(255,255,255,.10);
    }
    
    .btn:active, button:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: rgba(120,160,255,.20);
      border-color: rgba(120,160,255,.40);
    }
    
    .btn-primary:hover {
      background: rgba(120,160,255,.30);
    }
    
    select, input[type="text"] {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: var(--font);
      font-size: 14px;
    }
    
    select:focus, input[type="text"]:focus {
      outline: 2px solid rgba(120,160,255,.50);
      outline-offset: 1px;
    }

    .units-seg {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
    }
    
    .units-seg button {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }
    
    .units-seg button[aria-pressed="true"] {
      background: rgba(255,255,255,.06);
      color: var(--text);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      max-width: 45%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }
    
    .pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,.32);
    }

    main {
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
    }

    /* Cards */
    .card {
      border-radius: var(--radius);
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      border: 1px solid var(--border2);
      min-height: 420px;
      overflow: hidden;
    }
    
    .card-right {
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border2);
      min-height: 420px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .big {
      font-weight: 900;
      font-size: 64px;
      margin: 6px 0;
    }
    
    .sub {
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .stat {
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.06);
    }
    
    .stat .k {
      font-size: 12px;
      color: var(--muted2);
      font-weight: 700;
    }
    
    .stat .v {
      font-size: 15px;
      font-weight: 800;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,.06);
      margin: 12px 0;
    }

    /* Location controls */
    .location-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .location-input-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .location-input-group input {
      flex: 1;
      min-width: 200px;
    }
    
    .last-updated {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
    }

    /* Forecast list */
    .forecast-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 6px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .forecast-item {
      flex: 0 0 calc(20% - 8px);
      min-width: 120px;
      max-width: 220px;
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.06);
      cursor: pointer;
      transition: transform .12s ease, background .12s ease;
    }
    
    .forecast-item:focus, .forecast-item:hover {
      transform: translateY(-6px);
      background: rgba(255,255,255,.03);
      outline: 2px solid rgba(120,160,255,.40);
      outline-offset: 2px;
    }
    
    .forecast-item .icon {
      font-size: 20px;
    }
    
    .forecast-item .day {
      font-weight: 800;
      color: var(--text);
      font-size: 13px;
    }
    
    .forecast-item .temp {
      font-weight: 700;
      color: var(--text);
      font-size: 13px;
    }
    
    .forecast-item .verdict {
      font-weight: 900;
      color: var(--text);
      margin-top: 6px;
    }

    /* Desktop forecast button */
    .show-forecast-btn {
      display: none;
    }

    /* Bottom sheet for mobile - initially hidden */
    .bottom-sheet-backdrop {
      display: none;
    }
    
    .bottom-sheet {
      display: none;
    }

    /* Footer */
    .site-footer {
      margin-top: 12px;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      color: var(--muted);
      font-size: 12px;
      flex-wrap: wrap;
    }

    /* Reduced UI for low-power devices */
    .reduced-ui * {
      box-shadow: none !important;
      transition: none !important;
      animation: none !important;
    }
    
    .reduced-ui .forecast-item:hover,
    .reduced-ui .forecast-item:focus {
      transform: none;
    }

    /* Accessibility / reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        animation: none !important;
      }
    }

    /* Responsive: mobile layout with bottom sheet */
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      /* Hide right column on mobile, use bottom sheet instead */
      .card-right {
        display: none;
      }
      
      /* Show forecast toggle button on mobile */
      .show-forecast-btn {
        display: block;
        width: 100%;
        margin-top: 12px;
      }
      
      /* Bottom sheet styles */
      .bottom-sheet-backdrop {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,.60);
        backdrop-filter: blur(4px);
        z-index: 998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      
      .bottom-sheet-backdrop.open {
        opacity: 1;
        pointer-events: all;
      }
      
      .bottom-sheet {
        display: flex;
        flex-direction: column;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--panel);
        border-top-left-radius: var(--radius2);
        border-top-right-radius: var(--radius2);
        border: 1px solid var(--border);
        border-bottom: none;
        max-height: 85vh;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 999;
        box-shadow: 0 -12px 48px rgba(0,0,0,.8);
      }
      
      .bottom-sheet.open {
        transform: translateY(0);
      }
      
      .bottom-sheet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      
      .bottom-sheet-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 800;
      }
      
      .bottom-sheet-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        overscroll-behavior: contain;
      }
      
      .bottom-sheet .forecast-list {
        max-height: none;
      }
      
      .forecast-item {
        flex: 0 0 calc(50% - 10px);
      }
    }

    @media (max-width: 520px) {
      .forecast-item {
        flex: 0 0 calc(100% - 10px);
      }
      
      .big {
        font-size: 40px;
      }
      
      header {
        padding: 8px;
      }
      
      .wrap {
        padding: 8px;
      }
      
      .card {
        padding: 8px;
      }
      
      .units-seg button {
        padding: 6px 8px;
      }
      
      .location-input-group {
        flex-direction: column;
      }
      
      .location-input-group input {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-btn">üß•</div>
        <div class="wordmark">
          <div class="title">Hoodie or Nah</div>
          <div class="tag">Weather, simplified</div>
        </div>
      </div>
      <div class="header-right">
        <div class="units-seg" role="group" aria-label="Temperature units">
          <button id="unit-f" aria-pressed="true" onclick="setUnit('F')">¬∞F</button>
          <button id="unit-c" aria-pressed="false" onclick="setUnit('C')">¬∞C</button>
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <div class="card">
          <div class="location-controls">
            <div class="location-input-group">
              <button class="btn btn-primary" onclick="useGPS()">üìç Use my GPS</button>
              <input 
                type="text" 
                id="manual-location" 
                placeholder="Or enter lat,lon (e.g., 40.7128,-74.0060)" 
                onkeypress="if(event.key==='Enter') useManualLocation()"
              />
              <button class="btn" onclick="useManualLocation()">Go</button>
            </div>
            <div class="location-input-group">
              <button class="btn" id="refresh-btn" onclick="refreshWeather()">üîÑ Refresh</button>
              <div class="last-updated" id="last-updated"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="verdict-display">
            <div class="big" id="verdict-text">‚Äî</div>
            <div class="sub" id="verdict-subtitle">Load weather to get started</div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">TEMP</div>
              <div class="v" id="stat-temp">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">FEELS LIKE</div>
              <div class="v" id="stat-feels">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">WIND</div>
              <div class="v" id="stat-wind">‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">LOCATION</div>
              <div class="v" id="stat-location">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div>
            <label for="temp-preference" style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--muted);">
              How do you run?
            </label>
            <select id="temp-preference" onchange="updateVerdict()">
              <option value="0">Normal</option>
              <option value="-3">I run warm</option>
              <option value="3">I run cold</option>
            </select>
          </div>
        </div>

        <div class="card-right">
          <h3 style="margin: 0 0 8px 0; font-size: 16px;">7-Day Forecast</h3>
          <div class="forecast-list" id="forecast-list">
            <div style="color: var(--muted); font-size: 14px;">Load weather data to see forecast</div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary show-forecast-btn" onclick="toggleBottomSheet()">
        üìä Open forecast
      </button>
    </main>

    <footer class="site-footer">
      <div>
        Made with ‚òï | 
        <a href="https://github.com/oopsyoublinked/hoodieornah" target="_blank" rel="noopener">GitHub</a>
      </div>
      <div>
        Data from <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a>
      </div>
    </footer>
  </div>

  <!-- Bottom sheet for mobile -->
  <div class="bottom-sheet-backdrop" id="bottom-sheet-backdrop" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="bottom-sheet" role="dialog" aria-modal="true" aria-labelledby="sheet-title">
    <div class="bottom-sheet-header">
      <h3 id="sheet-title">7-Day Forecast</h3>
      <button class="btn" onclick="closeBottomSheet()" aria-label="Close forecast">Close</button>
    </div>
    <div class="bottom-sheet-content">
      <div class="forecast-list" id="forecast-list-mobile">
        <div style="color: var(--muted); font-size: 14px;">Load weather data to see forecast</div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // Cache Helper with localStorage
    // ========================================
    const CACHE_PREFIX = 'hoodie:cache:';

    /**
     * Fetch with cache
     * @param {string} key - Cache key
     * @param {function} fetcher - Async function that returns data
     * @param {number} ttlMs - Time to live in milliseconds
     * @param {boolean} force - Force fresh fetch, bypass cache
     * @returns {Promise<{data: any, fromCache: boolean, ts: number}>}
     */
    async function fetchWithCache(key, fetcher, ttlMs, force = false) {
      const cacheKey = CACHE_PREFIX + key;
      const now = Date.now();

      // Check cache unless forced
      if (!force) {
        try {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            const parsed = JSON.parse(cached);
            const age = now - parsed.ts;
            if (age < ttlMs) {
              console.log(`Cache hit for ${key}, age: ${Math.round(age / 1000)}s`);
              return { data: parsed.data, fromCache: true, ts: parsed.ts };
            }
          }
        } catch (e) {
          console.warn('Cache read error:', e);
        }
      }

      // Fetch fresh data
      console.log(`Fetching fresh data for ${key}`);
      const data = await fetcher();
      const cacheObj = { ts: now, data };

      try {
        localStorage.setItem(cacheKey, JSON.stringify(cacheObj));
      } catch (e) {
        console.warn('Cache write error:', e);
      }

      return { data, fromCache: false, ts: now };
    }

    // ========================================
    // Device Heuristics
    // ========================================
    function applyDeviceHeuristics() {
      const cores = navigator.hardwareConcurrency || 4;
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const effectiveType = connection ? connection.effectiveType : '4g';

      const isLowPower = cores < 2 || ['slow-2g', '2g', '3g'].includes(effectiveType);

      if (isLowPower) {
        document.documentElement.classList.add('reduced-ui');
        console.log('Low-power device detected, applying reduced UI');
      }
    }

    // ========================================
    // State Management
    // ========================================
    let currentUnit = 'F';
    let currentWeatherData = null;
    let currentForecastData = null;
    let currentLocation = { lat: null, lon: null, name: 'Unknown' };

    function setUnit(unit) {
      currentUnit = unit;
      document.getElementById('unit-f').setAttribute('aria-pressed', unit === 'F');
      document.getElementById('unit-c').setAttribute('aria-pressed', unit === 'C');
      
      // Re-render if we have data
      if (currentWeatherData) {
        updateVerdict();
      }
      if (currentForecastData) {
        renderForecast(currentForecastData);
      }
    }

    function tempConvert(tempC, unit) {
      if (unit === 'C') return Math.round(tempC);
      return Math.round(tempC * 9/5 + 32);
    }

    // ========================================
    // Weather Logic
    // ========================================
    function getVerdict(tempC, preference = 0) {
      const adjustedTemp = tempC + preference;
      
      if (adjustedTemp < 16) return { text: 'Hoodie', icon: 'üß•', color: '#6B9FFF' };
      if (adjustedTemp < 20) return { text: 'Maybe', icon: 'ü§î', color: '#FFB366' };
      return { text: 'Nah', icon: '‚òÄÔ∏è', color: '#FF6B6B' };
    }

    function updateVerdict() {
      if (!currentWeatherData) return;

      const preference = parseInt(document.getElementById('temp-preference').value || 0);
      const verdict = getVerdict(currentWeatherData.temperature, preference);

      document.getElementById('verdict-text').textContent = verdict.text;
      document.getElementById('verdict-text').style.color = verdict.color;
      document.getElementById('verdict-subtitle').textContent = `${verdict.icon} Based on current conditions`;

      // Update stats
      const temp = tempConvert(currentWeatherData.temperature, currentUnit);
      const feels = tempConvert(currentWeatherData.apparent_temperature || currentWeatherData.temperature, currentUnit);
      
      document.getElementById('stat-temp').textContent = `${temp}¬∞${currentUnit}`;
      document.getElementById('stat-feels').textContent = `${feels}¬∞${currentUnit}`;
      document.getElementById('stat-wind').textContent = `${Math.round(currentWeatherData.windspeed || 0)} mph`;
      document.getElementById('stat-location').textContent = currentLocation.name;
    }

    function renderForecast(forecastData) {
      if (!forecastData || !forecastData.daily) return;

      const days = forecastData.daily.time || [];
      const maxTemps = forecastData.daily.temperature_2m_max || [];
      const minTemps = forecastData.daily.temperature_2m_min || [];

      let html = '';
      for (let i = 0; i < Math.min(days.length, 7); i++) {
        const date = new Date(days[i]);
        const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
        const avgTemp = (maxTemps[i] + minTemps[i]) / 2;
        const verdict = getVerdict(avgTemp);
        
        const maxDisplay = tempConvert(maxTemps[i], currentUnit);
        const minDisplay = tempConvert(minTemps[i], currentUnit);

        html += `
          <div class="forecast-item" tabindex="0">
            <div class="icon">${verdict.icon}</div>
            <div class="day">${dayName}</div>
            <div class="temp">${maxDisplay}¬∞ / ${minDisplay}¬∞${currentUnit}</div>
            <div class="verdict" style="color: ${verdict.color}">${verdict.text}</div>
          </div>
        `;
      }

      // Update both desktop and mobile forecast lists
      document.getElementById('forecast-list').innerHTML = html;
      document.getElementById('forecast-list-mobile').innerHTML = html;
    }

    function formatTimestamp(ts) {
      if (!ts) return 'Never';
      const date = new Date(ts);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      
      if (diffMin < 1) return 'Just now';
      if (diffMin < 60) return `${diffMin} min ago`;
      
      const diffHour = Math.floor(diffMin / 60);
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // ========================================
    // API Calls
    // ========================================
    async function fetchWeather(lat, lon, force = false) {
      try {
        // Fetch current weather
        const currentResult = await fetchWithCache(
          `weather:${lat}:${lon}`,
          async () => {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,windspeed_10m&temperature_unit=celsius&windspeed_unit=mph`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Weather API error');
            return res.json();
          },
          5 * 60 * 1000, // 5 min TTL
          force
        );

        currentWeatherData = {
          temperature: currentResult.data.current.temperature_2m,
          apparent_temperature: currentResult.data.current.apparent_temperature,
          windspeed: currentResult.data.current.windspeed_10m
        };

        // Fetch 7-day forecast
        const forecastResult = await fetchWithCache(
          `forecast:${lat}:${lon}`,
          async () => {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&temperature_unit=celsius&timezone=auto`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Forecast API error');
            return res.json();
          },
          60 * 60 * 1000, // 1 hour TTL
          force
        );

        currentForecastData = forecastResult.data;

        // Update UI
        updateVerdict();
        renderForecast(currentForecastData);

        // Update last updated timestamp (use most recent)
        const latestTs = Math.max(currentResult.ts, forecastResult.ts);
        document.getElementById('last-updated').textContent = `Last updated: ${formatTimestamp(latestTs)}`;

        if (!force && currentResult.fromCache) {
          console.log('Loaded from cache');
        } else {
          console.log('Loaded fresh data');
        }
      } catch (error) {
        console.error('Error fetching weather:', error);
        alert('Failed to fetch weather data. Please try again.');
      }
    }

    async function useGPS() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
      }

      document.getElementById('verdict-subtitle').textContent = 'Getting your location...';

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          currentLocation = {
            lat,
            lon,
            name: `${lat.toFixed(2)}, ${lon.toFixed(2)}`
          };
          await fetchWeather(lat, lon);
        },
        (error) => {
          console.error('Geolocation error:', error);
          alert('Could not get your location. Please enter manually.');
          document.getElementById('verdict-subtitle').textContent = 'Location access denied';
        }
      );
    }

    function useManualLocation() {
      const input = document.getElementById('manual-location').value.trim();
      if (!input) {
        alert('Please enter a location in lat,lon format');
        return;
      }

      const parts = input.split(',').map(p => p.trim());
      if (parts.length !== 2) {
        alert('Invalid format. Use: latitude,longitude (e.g., 40.7128,-74.0060)');
        return;
      }

      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);

      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert('Invalid coordinates. Latitude must be -90 to 90, longitude -180 to 180');
        return;
      }

      currentLocation = { lat, lon, name: `${lat.toFixed(2)}, ${lon.toFixed(2)}` };
      fetchWeather(lat, lon);
    }

    function refreshWeather() {
      if (!currentLocation.lat || !currentLocation.lon) {
        alert('Please load weather data first');
        return;
      }

      document.getElementById('last-updated').textContent = 'Refreshing...';
      fetchWeather(currentLocation.lat, currentLocation.lon, true);
    }

    // ========================================
    // Bottom Sheet (Mobile)
    // ========================================
    const SHEET_STATE_KEY = 'hoodie:sheet-open';

    function toggleBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      const isOpen = sheet.classList.contains('open');

      if (isOpen) {
        closeBottomSheet();
      } else {
        openBottomSheet();
      }
    }

    function openBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      
      sheet.classList.add('open');
      backdrop.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      // Save state
      sessionStorage.setItem(SHEET_STATE_KEY, 'true');
      
      // Update button text
      const btn = document.querySelector('.show-forecast-btn');
      if (btn) btn.textContent = '‚ùå Close forecast';
    }

    function closeBottomSheet() {
      const sheet = document.getElementById('bottom-sheet');
      const backdrop = document.getElementById('bottom-sheet-backdrop');
      
      sheet.classList.remove('open');
      backdrop.classList.remove('open');
      document.body.style.overflow = '';
      
      // Save state
      sessionStorage.setItem(SHEET_STATE_KEY, 'false');
      
      // Update button text
      const btn = document.querySelector('.show-forecast-btn');
      if (btn) btn.textContent = 'üìä Open forecast';
    }

    // Keyboard accessibility
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sheet = document.getElementById('bottom-sheet');
        if (sheet.classList.contains('open')) {
          closeBottomSheet();
        }
      }
    });

    // ========================================
    // Initialization
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      // Apply device heuristics
      applyDeviceHeuristics();

      // Restore bottom sheet state on mobile
      const sheetState = sessionStorage.getItem(SHEET_STATE_KEY);
      if (sheetState === 'true' && window.innerWidth <= 900) {
        // Small delay to allow CSS to load
        setTimeout(() => openBottomSheet(), 100);
      }

      console.log('Hoodie or Nah - Ready!');
      console.log('Use "Use my GPS" or enter lat,lon to get started');
    });
  </script>
</body>
</html>
