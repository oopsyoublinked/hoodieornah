<!doctype html>
<html lang="en" class="theme-dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie judgment, delivered." />
  <meta name="theme-color" content="#0b0b0f" />

  <link rel="icon" href="data:,"> <style>
    /* --- VARIABLES & RESET --- */
    :root{
      --bg:#0b0b0f;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.76);
      --muted2: rgba(255,255,255,.64);
      --accent: rgba(255,255,255,.95);
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --shadow2: 0 10px 25px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; scroll-behavior: smooth; }
    
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      /* CRASH FIX: Solid background instead of complex gradients */
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
      transition: background .25s ease, color .25s ease;
    }

    .wrap{ max-width:1220px; margin:18px auto 28px; padding:0 18px 26px; }

    /* --- TOP BAR --- */
    /* CRASH FIX: Removed backdrop-filter, increased opacity */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 18px; border:1px solid var(--stroke); border-radius:999px;
      background: #111; 
      box-shadow: var(--shadow2); position:sticky; top:10px; z-index:50;
    }

    .brand{
      display:flex; align-items:center; gap:12px; min-width:220px; cursor:pointer; user-select:none;
    }
    .brand .mark{
      width:40px; height:40px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center; box-shadow:0 10px 25px rgba(0,0,0,.45);
      transition: transform .18s ease;
    }
    .brand .mark img{ width:26px; height:26px; display:block; }
    .brand:hover .mark{ transform: translateY(-1px) scale(1.02); }
    .brand .word{ display:flex; flex-direction:column; line-height:1.05; }
    .brand .word strong{ font-size:18px; letter-spacing:.01em; }
    .brand .word span{ font-size:12px; color: var(--muted); letter-spacing:.02em; }

    .controls{ display:flex; align-items:center; gap:10px; flex:1 1 auto; }

    .pillrow{
      display:flex;
      gap:8px;
      align-items:center;
      padding:6px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      flex-wrap: nowrap;
    }

    /* UI FIX: Added flex-shrink: 0 to prevent squashing */
    .seg, .pill{ height:36px; min-height:36px; align-items:center; flex-shrink: 0; }
    
    .seg{
      display:inline-flex; align-items:stretch; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; overflow:hidden; background: rgba(255,255,255,.03);
      flex:0 1 auto;
    }
    .seg button{
      border:0; background:transparent; color: var(--muted); padding:0 12px; font-size:13px; cursor:pointer;
      transition: background .16s ease, color .16s ease; display:inline-flex; align-items:center; height:100%;
    }
    .seg button:hover{ background: rgba(255,255,255,.05); color: var(--text); }
    .seg button[aria-pressed="true"]{ background: rgba(255,255,255,.15); color: #fff; font-weight: 700; }

    .pill{
      display:inline-flex; justify-content:center; align-items:center; gap:8px; padding:0 14px;
      border:1px solid rgba(255,255,255,.12); border-radius:999px; background: rgba(255,255,255,.03);
      color: var(--text); font-size:13px; cursor:pointer; user-select:none; line-height:1.3;
      transition: transform .16s ease; text-align:center;
      flex: 1 1 auto; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .pill:hover{ transform: translateY(-1px); }

    /* --- MAIN LAYOUT --- */
    .main{ margin-top:14px; display:grid; grid-template-columns:1.25fr .95fr; gap:14px; align-items:start; }
    
    /* Sticky Verdict on Desktop */
    @media (min-width: 981px) {
      #leftCard { position: sticky; top: 80px; }
    }
    @media (max-width:980px){ .brand{ min-width:unset; } .main{ grid-template-columns:1fr; } }

    /* --- CARDS --- */
    .card{
      border:1px solid rgba(255,255,255,.14); border-radius: var(--radius);
      /* CRASH FIX: Solid background */
      background: #15151a;
      box-shadow: var(--shadow); overflow:hidden; position:relative;
    }
    .card.loading{ opacity:.8; pointer-events: none; }
    .card-inner{ position:relative; padding:18px; min-height:100%; }
    
    /* UI FIX: Added clamp() to prevent huge text clipping */
    .bigword{ 
      font-size: clamp(48px, 6vw, 72px); 
      font-weight:900; letter-spacing:.02em; margin:6px 0 4px; line-height:.9; 
    }
    
    .oneliner{ color: var(--muted); font-size:15px; margin:0 0 16px; max-width:560px; line-height: 1.4; }

    .statrow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .stat{
      border:1px solid rgba(255,255,255,.14); border-radius: var(--radius2);
      background: rgba(0,0,0,.2); padding:12px 12px; min-height:70px;
    }
    .stat small{ display:block; color: var(--muted2); font-size:12px; margin-bottom:6px; }
    .stat strong{ display:block; font-size:15px; }
    .stat .sub{ margin-top:4px; color: var(--muted2); font-size:12px; }

    /* --- FORECAST (Mobile Swipe) --- */
    .forecast{ margin-top:14px; display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px; width:100%; }
    @media (max-width:640px){ 
      .forecast{ display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 10px; }
      .forecast-item { flex: 0 0 140px; scroll-snap-align: start; }
    }

    .forecast-item{
      min-width:0; border:1px solid rgba(255,255,255,.14); border-radius:18px;
      background: rgba(0,0,0,.2); padding:10px 10px; cursor:pointer;
      transition: transform .16s ease, background .16s ease;
      user-select:none; outline:none;
    }
    .forecast-item:hover{ transform: translateY(-2px); background: rgba(255,255,255,.07); }
    .forecast-item.selected{ border-color: rgba(255,255,255,.4); background: rgba(255,255,255,.1); }

    .forecast-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
    .forecast-top b{ font-size:13px; color: var(--text); white-space: normal; line-height:1.2; font-weight:700; }
    .forecast-mid{ margin-top:6px; font-size:12px; color: var(--muted); }
    .forecast-mid strong{ color: var(--text); font-size:14px; display:block; margin-top:3px; }
    .forecast-line{ margin-top:8px; font-size:12px; color: var(--muted2); line-height:1.25; min-height:34px; }

    .how-decided{
      margin-top:10px; color: var(--text); font-size:13px; line-height:1.4;
      max-width:620px; padding:8px 10px; border-radius:10px; background: var(--panel2); border:1px solid var(--stroke);
    }
    .how-decided b{ color: var(--text); font-weight:800; }

    .wear-box{
      margin-top:12px; border:1px solid rgba(255,255,255,.14); border-radius:14px;
      padding:10px 12px; background: rgba(0,0,0,.2); color: var(--text);
    }
    .wear-title{ font-size:11px; font-weight:800; margin-bottom:6px; color: var(--muted2); text-transform: uppercase; }
    .wear-list{ list-style:none; padding:0; margin:0; display:grid; gap:6px; font-size:13px; color: var(--text); }
    .wear-list li::before{ content:"‚Ä¢ "; color: var(--muted2); }

    .cta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    
    /* White Primary Button */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px;
      border:1px solid rgba(255,255,255,.3); border-radius:999px; background: rgba(255,255,255,.15);
      color: #fff; font-size:13px; font-weight: 600; cursor:pointer; text-decoration:none;
      transition: transform .16s ease, background .16s ease; user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.25); border-color: #fff; }
    
    .btn.secondary{ background: rgba(0,0,0,.2); border-color: rgba(255,255,255,.15); font-weight: 400; color: var(--muted); }
    .btn.secondary:hover{ background: rgba(255,255,255,.07); color: #fff; }

    .right-card h2{ margin:0; font-size:22px; letter-spacing:.01em; }
    .right-card .subhead{ margin-top:6px; color: var(--muted); font-size:13px; }

    label{ display:block; margin-top:12px; color: var(--muted2); font-size:11px; letter-spacing:.02em; font-weight: 700; text-transform: uppercase; }
    input{
      width:100%; margin-top:6px; padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.3); color: var(--text);
      outline:none; font-size:14px; transition: border-color .16s ease;
    }
    input:focus{ border-color: rgba(255,255,255,.4); }

    .form-row{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content: stretch; }
    .form-row .btn{ flex: 1 1 0; width: 100%; justify-content: center; }

    /* --- DETAILS DRAWER --- */
    .details{ margin-top:14px; border:1px solid rgba(255,255,255,.14); border-radius:18px; background: rgba(0,0,0,.2); overflow:hidden; }
    .details-header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.08);
    }
    .details-header b{ font-size:13px; }
    .details-body{ padding:12px; }
    .details-title{ font-size:16px; font-weight:800; color: var(--text); }
    .details-meta{ color:var(--muted); font-size:13px; display:flex; align-items:center; gap:8px; }
    
    .ataglance{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .ataglance .chip{
      border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:6px 10px; font-size:12px;
      color: var(--text); background: rgba(255,255,255,.10);
    }

    .sunrow{ width:100%; margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .sunbox{ border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,.06); }
    .sunlabel{ display:block; font-size:11px; color:var(--muted); text-transform: uppercase; letter-spacing:.02em; }
    .sunvalue{ display:block; margin-top:2px; font-size:14px; font-weight:700; color:var(--text); }

    .site-footer{
      margin-top:14px; border:1px solid rgba(255,255,255,.14); border-radius:16px; background: rgba(255,255,255,.05);
      padding:14px 14px; display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      color: var(--muted2); font-size:12px; line-height:1.3; flex-wrap:wrap;
    }
    .site-footer a{ color: rgba(255,255,255,.85); text-decoration:none; border-bottom:1px solid rgba(255,255,255,.20); }

    .toast{
      position: fixed; left:50%; bottom:18px; transform: translateX(-50%);
      background: rgba(10,10,14,.95); border:1px solid rgba(255,255,255,.14); border-radius:999px;
      padding:10px 14px; color: rgba(255,255,255,.92); box-shadow: var(--shadow2);
      opacity:0; pointer-events:none; transition: opacity .20s ease, transform .20s ease; z-index:120; font-size:13px; max-width:92vw;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    .loading-shimmer{ opacity:.85; animation: pulse 1.1s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{ opacity:.85; } 50%{ opacity:.55; } }

    /* Mobile reordering */
    @media (max-width: 720px){
      .wrap{ padding: 0 12px 24px; }
      .topbar{ flex-direction: column; align-items: stretch; border-radius: 22px; position: static; }
      .controls{ flex-direction: column; width: 100%; }
      .pillrow{ width: 100%; }
      .pill{ flex: 1; padding: 0 12px; }
      .seg { flex: 1; width: 100%; justify-content: center; }
      .seg button { flex: 1; }
      .main{ display: flex; flex-direction: column; }
      #rightCard { order: 1; }
      #leftCard { order: 2; }
      #detailsCard { order: 3; }
      .bigword { font-size: 58px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" id="brandHome" title="Tap to refresh location">
        <div class="mark" aria-hidden="true"><img src="/logo-mark.png" alt=""></div>
        <div class="word">
          <strong>Hoodie or Nah</strong>
          <span>Hoodie judgment, delivered.</span>
        </div>
      </div>

      <div class="controls">
        <div class="pillrow">
          <div class="seg" aria-label="Units">
            <button id="unitAuto" type="button" aria-pressed="true">Auto</button>
            <button id="unitF" type="button" aria-pressed="false">¬∞F</button>
            <button id="unitC" type="button" aria-pressed="false">¬∞C</button>
          </div>
          <div class="pill" id="wherePill" title="Jump to forecast details">
            <span aria-hidden="true">üìç</span>
            <span id="pillText">Near you</span>
          </div>
        </div>
      </div>
    </div>

    <div class="main" id="mainLayout">
      <div class="card right-card" id="rightCard">
        <div class="card-inner">
          <h2>How do you run?</h2>
          <div class="subhead">Be honest. We can tell.</div>

          <label>Temperature preference</label>
          <div class="seg" id="runSeg" style="width: 100%; display: flex;">
            <button data-val="cold" type="button">I run cold</button>
            <button data-val="normal" type="button" aria-pressed="true">Normal</button>
            <button data-val="hot" type="button">I run hot</button>
          </div>

          <label for="manualInput">Manual location (optional)</label>
          <input id="manualInput" list="locList" placeholder="City, Region, Country or ZIP" autocomplete="off" />
          <datalist id="locList"></datalist>

          <div class="form-row">
            <button class="btn secondary" id="spinBtn" type="button">Spin the globe</button>
            <button class="btn secondary" id="gpsBtn" type="button">Use my GPS</button>
          </div>
        </div>
      </div>

      <div class="card" id="leftCard">
        <div class="card-inner">
          <div class="bigword" id="bigWord">LOADING</div>
          <div class="oneliner" id="oneLiner">Fetching your weather so we can judge you properly.</div>

          <div class="statrow">
            <div class="stat">
              <small>Location</small>
              <strong id="locName">Near you</strong>
              <div class="sub" id="locSource">Source: auto</div>
            </div>
            <div class="stat">
              <small>Right now</small>
              <strong id="nowTemp">--</strong>
              <div class="sub" id="nowSub">Feels like: -- | Wind: --</div>
            </div>
          </div>

          <div class="forecast" id="forecastList" aria-label="5 day forecast"></div>

          <div class="how-decided">
            <b>How we decided:</b> feels-like temp, wind, and how you said you run. Not your fashion sense.
          </div>

          <div class="wear-box">
            <div class="wear-title">What to wear</div>
            <ul class="wear-list" id="wearList">
              <li>Midweight hoodie; add a shell if wind is mouthy.</li>
            </ul>
          </div>

          <div class="cta">
            <a class="btn primary" href="https://buymeacoffee.com/hoodieornah" target="_blank" rel="noopener">Support the hoodie science</a>
          </div>
        </div>
      </div>

      <div class="card details-card" id="detailsCard">
        <div class="card-inner">
          <div class="details" id="detailsDrawer">
            <div class="details-header">
              <b>Forecast details</b>
              <span style="color:var(--muted2); font-size:12px;" id="detailsHint">Auto-filled for today</span>
            </div>
            <div class="details-body">
              <div class="details-title" id="detailsDay">--</div>

              <div class="details-meta" style="margin-top:8px;">
                <span id="detailsIcon" aria-hidden="true"></span>
                <span id="detailsSummary">--</span>
              </div>

              <div style="margin-top:10px; color:var(--muted); font-size:13px;">
                <b id="detailsDecision">--</b>
                <div id="detailsText" style="margin-top:4px;">--</div>
                <div style="margin-top:8px;">
                  High: <span id="detailsHigh">--</span> |
                  Low: <span id="detailsLow">--</span>
                </div>
              </div>

              <div class="ataglance" id="chipsRow"></div>

              <div class="sunrow">
                <div class="sunbox">
                  <span class="sunlabel">Sun up</span>
                  <span class="sunvalue" id="sunUp">--</span>
                </div>
                <div class="sunbox">
                  <span class="sunlabel">Sun down</span>
                  <span class="sunvalue" id="sunDown">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="site-footer">
      <div>
        <b>Contact</b><br />
        <a href="mailto:info@hoodieornah.com">info@hoodieornah.com</a><br />
        We read it. Eventually.
      </div>
      <div style="max-width: 720px;">
        Weather data via Open-Meteo. Geocoding via OpenStreetMap Nominatim.<br />
        This site is for entertainment and mild arguments only. No warranties.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const el = {
      brandHome: document.getElementById("brandHome"),
      leftCard: document.getElementById("leftCard"),
      rightCard: document.getElementById("rightCard"),
      detailsCard: document.getElementById("detailsCard"),
      unitAuto: document.getElementById("unitAuto"),
      unitF: document.getElementById("unitF"),
      unitC: document.getElementById("unitC"),
      wherePill: document.getElementById("wherePill"),
      pillText: document.getElementById("pillText"),

      bigWord: document.getElementById("bigWord"),
      oneLiner: document.getElementById("oneLiner"),
      locName: document.getElementById("locName"),
      locSource: document.getElementById("locSource"),
      nowTemp: document.getElementById("nowTemp"),
      nowSub: document.getElementById("nowSub"),
      forecastList: document.getElementById("forecastList"),

      wearList: document.getElementById("wearList"),
      runSeg: document.getElementById("runSeg"),
      manualInput: document.getElementById("manualInput"),
      locList: document.getElementById("locList"),
      spinBtn: document.getElementById("spinBtn"),
      gpsBtn: document.getElementById("gpsBtn"),

      detailsDrawer: document.getElementById("detailsDrawer"),
      detailsHint: document.getElementById("detailsHint"),
      detailsDay: document.getElementById("detailsDay"),
      detailsIcon: document.getElementById("detailsIcon"),
      detailsSummary: document.getElementById("detailsSummary"),
      detailsDecision: document.getElementById("detailsDecision"),
      detailsText: document.getElementById("detailsText"),
      detailsHigh: document.getElementById("detailsHigh"),
      detailsLow: document.getElementById("detailsLow"),
      chipsRow: document.getElementById("chipsRow"),
      sunUp: document.getElementById("sunUp"),
      sunDown: document.getElementById("sunDown"),

      toast: document.getElementById("toast"),
      mainLayout: document.getElementById("mainLayout")
    };

    const CURATED_CITIES = [
      { label:"Las Vegas, NV", lat:36.1699, lon:-115.1398, cc:"US" },
      { label:"Tulsa, OK", lat:36.15398, lon:-95.99277, cc:"US" },
      { label:"Dallas, TX", lat:32.7767, lon:-96.7970, cc:"US" },
      { label:"Austin, TX", lat:30.2672, lon:-97.7431, cc:"US" },
      { label:"Chicago, IL", lat:41.8781, lon:-87.6298, cc:"US" },
      { label:"New York, NY", lat:40.7128, lon:-74.0060, cc:"US" },
      { label:"Los Angeles, CA", lat:34.0522, lon:-118.2437, cc:"US" },
      { label:"Seattle, WA", lat:47.6062, lon:-122.3321, cc:"US" },
      { label:"Denver, CO", lat:39.7392, lon:-104.9903, cc:"US" },
      { label:"Miami, FL", lat:25.7617, lon:-80.1918, cc:"US" },
      { label:"Phoenix, AZ", lat:33.4484, lon:-112.0740, cc:"US" },
      { label:"Boston, MA", lat:42.3601, lon:-71.0589, cc:"US" },
      { label:"Atlanta, GA", lat:33.7490, lon:-84.3880, cc:"US" },
      { label:"San Francisco, CA", lat:37.7749, lon:-122.4194, cc:"US" },
      { label:"London, UK", lat:51.5072, lon:-0.1276, cc:"GB" },
      { label:"Paris, France", lat:48.8566, lon:2.3522, cc:"FR" },
      { label:"Berlin, Germany", lat:52.5200, lon:13.4050, cc:"DE" },
      { label:"Rome, Italy", lat:41.9028, lon:12.4964, cc:"IT" },
      { label:"Madrid, Spain", lat:40.4168, lon:-3.7038, cc:"ES" },
      { label:"Tokyo, Japan", lat:35.6762, lon:139.6503, cc:"JP" },
      { label:"Seoul, South Korea", lat:37.5665, lon:126.9780, cc:"KR" },
      { label:"Sydney, Australia", lat:-33.8688, lon:151.2093, cc:"AU" },
      { label:"Melbourne, Australia", lat:-37.8136, lon:144.9631, cc:"AU" },
      { label:"Auckland, New Zealand", lat:-36.8485, lon:174.7633, cc:"NZ" },
      { label:"Toronto, Canada", lat:43.6532, lon:-79.3832, cc:"CA" },
      { label:"Vancouver, Canada", lat:49.2827, lon:-123.1207, cc:"CA" },
      { label:"Mexico City, Mexico", lat:19.4326, lon:-99.1332, cc:"MX" },
      { label:"S√£o Paulo, Brazil", lat:-23.5505, lon:-46.6333, cc:"BR" },
      { label:"Buenos Aires, Argentina", lat:-34.6037, lon:-58.3816, cc:"AR" },
      { label:"Cape Town, South Africa", lat:-33.9249, lon:18.4241, cc:"ZA" },
      { label:"Cairo, Egypt", lat:30.0444, lon:31.2357, cc:"EG" },
      { label:"Dubai, UAE", lat:25.2048, lon:55.2708, cc:"AE" },
      { label:"Mumbai, India", lat:19.0760, lon:72.8777, cc:"IN" },
      { label:"Singapore", lat:1.3521, lon:103.8198, cc:"SG" }
    ];

    const WEATHER_CODES = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",
      45:"Fog",48:"Rime fog",51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",81:"Heavy showers",82:"Violent showers",
      95:"Thunderstorm",96:"Thunderstorm with hail",99:"Thunderstorm with heavy hail"
    };

    const QUIPS = {
      HOODIE: [
        "Yes. Hoodie plus life choices that include layers.",
        "Yep. Hoodie weather. Enjoy the smug warmth.",
        "Hoodie time. Your ears will send a thank-you note.",
        "Put the hood up and pretend you are mysterious.",
        "Wear the hoodie. Regret is for bare wrists.",
        "This is hoodie weather and it knows it.",
        "Hoodie recommended. Bonus points for pockets.",
        "If you skip the hoodie, you will think about it all day.",
        "Hoodie season. Lean into it.",
        "Hoodie on. The wind is being rude.",
        "Hoodie is the correct moral choice here.",
        "You want sleeves and plausible deniability. Hoodie.",
        "Yes hoodie. The air is spicy.",
        "Hoodie now. Your future self is grateful.",
        "Hoodie. You can still look cool while surviving."
      ],
      MAYBE: [
        "Could go either way. Hoodie if you like options.",
        "Borderline. Hoodie for the shade, nah for the sun.",
        "A true toss-up. Bring the hoodie just to feel powerful.",
        "Not cold, not warm. Annoyingly in-between.",
        "Hoodie if you will be outside longer than five minutes.",
        "Maybe hoodie. The wind might try something.",
        "Coin-flip weather. Hoodie is the insurance policy.",
        "Maybe hoodie. Mostly for the pockets.",
        "Borderline. Hoodie for mornings, nah for afternoons.",
        "Layer-friendly weather. Hoodie on standby."
      ],
      NAH: [
        "Nope. Hoodie would be a personal attack on your pores.",
        "Nah. Let your shoulders live a little.",
        "Skip the hoodie. You are not in a music video.",
        "No hoodie. Hydrate and pretend you are fine.",
        "Hoodie would be spicy overkill. Pass.",
        "Too warm. Hoodie is cosplay at this point.",
        "Let the breeze live rent-free. No hoodie.",
        "Nah. Pocket warmth not required today."
      ],
      PARKA: [
        "Parka time. Hoodie alone is a betrayal.",
        "Layer the hoodie under a parka. Trust me.",
        "Parka or bust. Your eyelashes would like to stay unfrosted.",
        "Parka weather. Hoodie is the understudy.",
        "Parka plus hoodie. Fashion is now survival."
      ]
    };

    const state = loadState() || {
      lat: null,
      lon: null,
      placeLabel: "Near you",
      countryCode: null,
      source: "auto",
      units: "F",
      unitOverride: null,
      run: "normal",
      lastForecast: null,
      selectedIdx: 0,
      spinSeen: [],
      isRefreshing: false,
      lastFetch: 0
    };

    function saveState(){
      try{ localStorage.setItem("hoodieornah_state_v4", JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem("hoodieornah_state_v4");
        if (!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    function showToast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      setTimeout(() => el.toast.classList.remove("show"), 2200);
    }

    function setLoadingUI(){
      // JS FIX: Reset bigword to text, remove visible error state
      el.bigWord.textContent = "LOADING";
      el.bigWord.classList.add("loading-shimmer");
      el.oneLiner.textContent = "Fetching weather receipts...";
      el.leftCard?.classList.add("loading");
    }
    function endLoadingUI(){
      el.leftCard?.classList.remove("loading");
      el.bigWord.classList.remove("loading-shimmer");
    }

    function setPill(text){ el.pillText.textContent = text || "Near you"; }
    function updateSourceUI(){
      const src = state.source || "auto";
      const label = src === "gps" ? "gps" : src === "manual" ? "manual" : src === "globe" ? "globe" : "auto";
      el.locSource.textContent = "Source: " + label;
    }

    function countryUsesF(cc){
      const f = new Set(["US","BS","BZ","KY","PW","FM","MH","LR"]);
      return cc && f.has(cc.toUpperCase());
    }
    function currentUnits(){
      if (state.unitOverride === "F") return "F";
      if (state.unitOverride === "C") return "C";
      return state.units || "F";
    }

    function setUnitControlButtons(){
      const u = currentUnits();
      el.unitAuto.setAttribute("aria-pressed", state.unitOverride ? "false" : "true");
      el.unitF.setAttribute("aria-pressed", u === "F" ? "true" : "false");
      el.unitC.setAttribute("aria-pressed", u === "C" ? "true" : "false");
    }

    function fmtTemp(v){
      if (v==null || Number.isNaN(v)) return "--";
      return Math.round(v) + "¬∞" + currentUnits();
    }
    function windText(ms){
      if (ms==null || Number.isNaN(ms)) return "--";
      const mph = ms * 2.236936;
      return Math.round(mph) + " mph";
    }
    function fmtTimeHM(iso){
      if (!iso) return "--";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "--";
      return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
    }

    function verdictForFeels(feelsF, run, windMps){
      const mph = (windMps || 0) * 2.236936;
      let adj = feelsF;
      if (run === "cold") adj -= 3;
      if (run === "hot") adj += 3;
      adj -= mph * 0.15;
      if (adj <= 40) return { key:"PARKA" };
      if (adj <= 55) return { key:"HOODIE" };
      if (adj <= 68) return { key:"MAYBE" };
      return { key:"NAH" };
    }

    function iconForCode(code){
      const c = Number(code);
      const map = { sun:"‚òÄÔ∏è", cloud:"‚òÅÔ∏è", fog:"üå´Ô∏è", rain:"üåßÔ∏è", storm:"‚õàÔ∏è", snow:"‚ùÑÔ∏è" };
      if (c === 0) return map.sun;
      if (c >= 1 && c <= 3) return map.cloud;
      if (c === 45 || c === 48) return map.fog;
      if ((c >= 51 && c <= 67) || (c >= 80 && c <= 82)) return map.rain;
      if (c >= 71 && c <= 77) return map.snow;
      if (c >= 95) return map.storm;
      return "üå°Ô∏è";
    }

    function pickQuip(word){
      const pool = QUIPS[word] || ["Weather is doing a thing. You do you."];
      return pool[Math.floor(Math.random()*pool.length)];
    }

    // UPDATED: Now supports Day/Night logic and Rain
    function renderBigVerdict(feelsF, run, windMps, precipPct, code, isDay){
      const verdict = verdictForFeels(feelsF, run, windMps);
      el.bigWord.textContent = verdict.key;
      el.oneLiner.textContent = pickQuip(verdict.key);
      
      const items = [];
      // 1. Verdict Gear
      if (verdict.key === "PARKA") items.push("Heavy jacket or parka.");
      else if (verdict.key === "HOODIE") items.push("A decent hoodie.");
      else if (verdict.key === "MAYBE") items.push("Light hoodie or long-sleeve.");
      else items.push("T-shirt or tank. It's warm.");

      // 2. Precip
      if (precipPct > 30) items.push("Waterproof shell (rain likely).");
      
      // 3. Day/Night
      if (!isDay) {
          items.push("Reflective gear (be seen).");
          items.push("Headlamp if off-road.");
      } else if (code <= 2) { 
          items.push("Sunglasses (it's bright).");
      }

      el.wearList.innerHTML = items.map(i => `<li>${i}</li>`).join("");
    }

    function renderForecast(dailyArr){
      el.forecastList.innerHTML = "";
      dailyArr.forEach((d, idx) => {
        const div = document.createElement("button");
        div.className = "forecast-item";
        div.type = "button";
        div.setAttribute("data-idx", String(idx));
        div.innerHTML = `
          <div class="forecast-top">
            <b>${new Date(d.date).toLocaleDateString(undefined, {weekday:'short'})}</b>
            <span style="font-size:20px">${iconForCode(d.code)}</span>
          </div>
          <div class="forecast-mid">
            ${WEATHER_CODES[d.code] || "Weather"}
            <strong>${fmtTemp(d.tMax)} / ${fmtTemp(d.tMin)}</strong>
          </div>
          <div class="forecast-line">
            Precip: ${d.precip ?? "--"}%
          </div>
        `;
        div.addEventListener("click", () => selectForecastIndex(idx));
        el.forecastList.appendChild(div);
      });
      selectForecastIndex(0, true);
    }

    function renderDetails(d, run){
      el.detailsDay.textContent = new Date(d.date).toLocaleDateString(undefined, {weekday:'long', month:'short', day:'numeric'});
      el.detailsIcon.innerHTML = `<span style="font-size:32px">${iconForCode(d.code)}</span>`;
      el.detailsSummary.textContent = WEATHER_CODES[d.code] || "Weather";

      const feelsMid = (d.appMax + d.appMin) / 2;
      const verdict = verdictForFeels(feelsMid, run, d.wind);

      el.detailsDecision.textContent = verdict.key;
      el.detailsText.textContent = pickQuip(verdict.key);
      el.detailsHigh.textContent = fmtTemp(d.tMax);
      el.detailsLow.textContent = fmtTemp(d.tMin);
      el.sunUp.textContent = fmtTimeHM(d.sunrise);
      el.sunDown.textContent = fmtTimeHM(d.sunset);

      const chips = [
        "Feels: " + fmtTemp(feelsMid),
        "Wind: " + windText(d.wind),
        "Precip: " + (d.precip ?? "--") + "%"
      ];
      el.chipsRow.innerHTML = chips.map(c => "<span class=\"chip\">" + c + "</span>").join("");
    }

    function selectForecastIndex(idx, fromAuto=false){
      state.selectedIdx = idx;
      saveState();

      [...el.forecastList.children].forEach((c,i)=> c.classList.toggle("selected", i===idx));
      const d = (state.lastForecast || [])[idx];
      if (!d) return;

      renderDetails(d, state.run);
      el.detailsHint.textContent = fromAuto ? "Auto-filled for today" : "Showing selection";
      if(!fromAuto) el.detailsCard.scrollIntoView({ behavior:"smooth", block: "nearest" });
    }

    async function refreshWeather(){
      // CRASH FIX: Prevents infinite recursion
      if (state.isRefreshing) return;
      if (Date.now() - state.lastFetch < 3000) return; // 3s Debounce

      if (!state.lat || !state.lon){
        try{
          await useGPS(true);
        }catch(e){
          const fallback = CURATED_CITIES[0];
          await setLocation(fallback.lat, fallback.lon, fallback.label, fallback.cc, "auto");
        }
        return;
      }

      state.isRefreshing = true;
      setLoadingUI();

      try{
        const units = currentUnits() === "F" ? "fahrenheit" : "celsius";
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&temperature_unit=${units}&wind_speed_unit=ms&timezone=auto&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset`;
        
        const res = await fetch(url);
        if (!res.ok) throw new Error("API_ERR");
        const data = await res.json();

        state.lastForecast = data.daily.time.map((t, i) => ({
            date: t, code: data.daily.weather_code[i],
            tMax: data.daily.temperature_2m_max[i], tMin: data.daily.temperature_2m_min[i],
            appMax: data.daily.apparent_temperature_max[i], appMin: data.daily.apparent_temperature_min[i],
            precip: data.daily.precipitation_probability_max[i], wind: data.daily.wind_speed_10m_max[i],
            sunrise: data.daily.sunrise[i], sunset: data.daily.sunset[i]
        }));
        saveState();

        el.locName.textContent = state.placeLabel || "Near you";
        el.nowTemp.textContent = fmtTemp(data.current.temperature_2m);
        el.nowSub.textContent = `Feels: ${fmtTemp(data.current.apparent_temperature)} | Wind: ${windText(data.current.wind_speed_10m)}`;

        renderForecast(state.lastForecast);
        
        // Use updated Render Logic (Day/Night)
        const todayDaily = state.lastForecast[0];
        renderBigVerdict(
          data.current.apparent_temperature,
          state.run,
          data.current.wind_speed_10m,
          todayDaily?.precip ?? 0,
          todayDaily?.code ?? 0,
          data.current.is_day === 1
        );
        
        state.lastFetch = Date.now();

      }catch(e){
        console.error(e);
        // JS FIX: Explicit Error State
        el.bigWord.textContent = "ERROR";
        el.oneLiner.textContent = "Weather data unavailable. Check connection.";
        showToast("Weather data failed.");
      }finally{
        state.isRefreshing = false;
        endLoadingUI();
      }
    }

    async function setLocation(lat, lon, placeLabel, countryCode, source){
      state.lat = lat; state.lon = lon;
      state.placeLabel = placeLabel; state.countryCode = countryCode;
      state.source = source;
      state.units = countryUsesF(state.countryCode) ? "F" : "C";
      saveState();
      
      setPill(state.placeLabel);
      updateSourceUI();
      setUnitControlButtons();
      await refreshWeather();
    }

    async function useGPS(silent=false){
      if (!navigator.geolocation) throw new Error("no_gps");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          try{
            const { latitude:lat, longitude:lon } = pos.coords;
            // Simple reverse geo label
            await setLocation(lat, lon, "Current Location", "US", "gps");
            if (!silent) showToast("Location set by GPS");
            resolve();
          }catch(err){ reject(err); }
        }, (err)=>{
          if (!silent) showToast("GPS denied. Use manual or Spin.");
          reject(err);
        });
      });
    }

    function spinCity(){
      if (!Array.isArray(state.spinSeen)) state.spinSeen = [];
      const all = CURATED_CITIES.map((_,i)=>i);
      const remaining = all.filter(i => !state.spinSeen.includes(i));
      const pickIdx = remaining.length ? remaining[Math.floor(Math.random()*remaining.length)] : all[Math.floor(Math.random()*all.length)];
      const city = CURATED_CITIES[pickIdx];
      state.spinSeen = remaining.length ? [...state.spinSeen, pickIdx] : [pickIdx];
      saveState();
      setLocation(city.lat, city.lon, city.label, city.cc, "globe");
      showToast("Spun: " + city.label);
    }

    // Handlers
    el.unitAuto.onclick = ()=>{ state.unitOverride=null; setUnitControlButtons(); refreshWeather(); };
    el.unitF.onclick = ()=>{ state.unitOverride="F"; setUnitControlButtons(); refreshWeather(); };
    el.unitC.onclick = ()=>{ state.unitOverride="C"; setUnitControlButtons(); refreshWeather(); };

    el.brandHome.onclick = ()=>{ refreshWeather(); };
    el.wherePill.onclick = ()=>{ el.detailsCard.scrollIntoView({ behavior:"smooth" }); };
    el.spinBtn.onclick = spinCity;
    el.gpsBtn.onclick = ()=>useGPS();

    el.runSeg.querySelectorAll('button').forEach(btn => {
      btn.onclick = () => {
        state.run = btn.dataset.val;
        el.runSeg.querySelectorAll('button').forEach(b => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');
        saveState(); refreshWeather();
      };
    });

    // Input Debounce
    let inputTimeout;
    el.manualInput.oninput = (e) => {
      clearTimeout(inputTimeout);
      inputTimeout = setTimeout(async () => {
        const q = e.target.value.trim();
        if (q.length < 3) return;
        try {
          const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
          const d = await r.json();
          el.locList.innerHTML = d.map(x => 
            `<option value="${x.display_name}" data-lat="${x.lat}" data-lon="${x.lon}"></option>`
          ).join("");
        } catch(e) {}
      }, 800);
    };

    el.manualInput.onchange = (e) => {
      const val = e.target.value;
      const opt = [...el.locList.options].find(o => o.value === val);
      if(opt){
        setLocation(Number(opt.dataset.lat), Number(opt.dataset.lon), val.split(",")[0], "US", "manual");
        el.manualInput.blur();
      }
    };

    // Init
    setUnitControlButtons();
    setPill(state.placeLabel || "Near you");
    updateSourceUI();
    
    const runBtn = [...el.runSeg.querySelectorAll('button')].find(b => b.dataset.val === state.run);
    if(runBtn){
       el.runSeg.querySelectorAll('button').forEach(b => b.setAttribute('aria-pressed', 'false'));
       runBtn.setAttribute('aria-pressed', 'true');
    }

    setLoadingUI();
    refreshWeather();

  </script>
</body>
</html>
