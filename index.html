<!doctype html>
<html lang="en" class="theme-dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoodie or Nah</title>
  <meta name="description" content="Settle the hoodie debate. Hoodie judgment, delivered." />
  <meta name="theme-color" content="#0b0b0f" />

  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="/favicon-32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/favicon-16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
  <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192" />
  <link rel="icon" type="image/png" href="/android-chrome-512x512.png" sizes="512x512" />
  <meta property="og:title" content="Hoodie or Nah?" />
  <meta property="og:description" content="Settle the hoodie debate in one click based on the weather." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://hoodieornah.com" />
  <meta property="og:image" content="https://hoodieornah.com/og.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.76);
      --muted2: rgba(255,255,255,.64);
      --accent: rgba(255,255,255,.95);
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --shadow2: 0 10px 25px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 520px at 20% 10%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 520px at 40% 90%, rgba(255,255,255,.05), transparent 65%),
        var(--bg);
      color: var(--text);
      overflow-x:hidden;
      transition: background .25s ease, color .25s ease;
    }
    .wrap{ max-width:1220px; margin:18px auto 28px; padding:0 18px 26px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 18px; border:1px solid var(--stroke); border-radius:999px;
      background: linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow2); position:sticky; top:10px; backdrop-filter: blur(14px); z-index:50;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:220px; cursor:pointer; user-select:none;
    }
    .brand .mark{
      width:40px; height:40px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center; box-shadow:0 10px 25px rgba(0,0,0,.45);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .brand .mark img{ width:26px; height:26px; display:block; }
    .brand:hover .mark{ transform: translateY(-1px) scale(1.02); filter: drop-shadow(0 0 12px rgba(255,255,255,.10)); }
    .brand .word{ display:flex; flex-direction:column; line-height:1.05; }
    .brand .word strong{ font-size:18px; letter-spacing:.01em; }
    .brand .word span{ font-size:12px; color: var(--muted); letter-spacing:.02em; }

    .controls{ display:flex; align-items:center; gap:10px; }
    .pillrow{
      display:flex; gap:8px; align-items:center; padding:4px;
      border-radius:999px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    }
    .seg, .pill{ height:36px; min-height:36px; align-items:center; }
    .seg{
      display:inline-flex; align-items:stretch; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; overflow:hidden; background: rgba(255,255,255,.03);
    }
    .seg button{
      border:0; background:transparent; color: var(--muted); padding:0 12px; font-size:13px; cursor:pointer;
      transition: background .16s ease, color .16s ease; display:inline-flex; align-items:center; height:100%;
    }
    .seg button:hover{ background: rgba(255,255,255,.05); color: var(--text); }
    .seg button[aria-pressed="true"]{ background: rgba(255,255,255,.08); color: var(--text); }
    .pill{
      display:inline-flex; justify-content:center; align-items:center; gap:8px; padding:0 12px;
      border:1px solid rgba(255,255,255,.12); border-radius:999px; background: rgba(255,255,255,.03);
      color: var(--text); font-size:13px; cursor:pointer; user-select:none; white-space: nowrap; line-height:1.2;
      transition: background .16s ease, border-color .16s ease, transform .16s ease; text-align:center;
    }
    .pill:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
    .pill[aria-pressed="true"]{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.22); }

    .main{ margin-top:14px; display:grid; grid-template-columns:1.25fr .95fr; gap:14px; align-items:stretch; }
    @media (max-width:980px){ .brand{ min-width:unset; } .main{ grid-template-columns:1fr; } }

    .card{
      border:1px solid rgba(255,255,255,.14); border-radius: var(--radius);
      background: linear-gradient(to bottom, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow); overflow:hidden; position:relative; height:100%;
    }
    .card.loading{ opacity:.82; filter:saturate(.85); box-shadow:0 12px 30px rgba(0,0,0,.38); }
    .card::before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(420px 220px at 20% 0%, rgba(255,255,255,.07), transparent 60%);
      pointer-events:none;
    }
    .card-inner{ position:relative; padding:18px; min-height:100%; }
    .bigword{ font-size:72px; font-weight:900; letter-spacing:.02em; margin:6px 0 4px; line-height:.9; }
    .oneliner{ color: var(--muted); font-size:15px; margin:0 0 16px; max-width:560px; }

    .statrow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .stat{
      border:1px solid rgba(255,255,255,.14); border-radius: var(--radius2);
      background: rgba(0,0,0,.12); padding:12px 12px; min-height:70px;
    }
    .stat small{ display:block; color: var(--muted2); font-size:12px; margin-bottom:6px; }
    .stat strong{ display:block; font-size:15px; }
    .stat .sub{ margin-top:4px; color: var(--muted2); font-size:12px; }

    .forecast{
      margin-top:14px; display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px; width:100%;
      overflow:visible;
    }
    @media (max-width:900px){ .forecast{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:520px){ .forecast{ grid-template-columns:1fr; } }

    .forecast-item{
      min-width:0; border:1px solid rgba(255,255,255,.14); border-radius:18px;
      background: rgba(0,0,0,.12); padding:10px 10px; cursor:pointer;
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none; outline:none;
    }
    .forecast-item:hover{ transform: translateY(-2px); background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.20); }
    .forecast-item:focus-visible{ box-shadow: 0 0 0 3px rgba(255,255,255,.14); }
    .forecast-item.selected{ border-color: rgba(255,255,255,.26); background: rgba(255,255,255,.09); }

    .forecast-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
    .forecast-top b{ font-size:13px; color: var(--text); white-space: normal; line-height:1.2; font-weight:700; }
    .forecast-top svg{ width:24px; height:24px; opacity:.98; color: var(--accent); flex:0 0 auto; }

    .forecast-mid{ margin-top:6px; font-size:12px; color: var(--muted); }
    .forecast-mid strong{ color: var(--text); font-size:14px; display:block; margin-top:3px; }
    .forecast-line{ margin-top:8px; font-size:12px; color: var(--muted2); line-height:1.25; min-height:34px; }

    .how-decided{
      margin-top:10px; color: var(--text); font-size:13px; line-height:1.4;
      max-width:620px; padding:8px 10px; border-radius:10px; background: var(--panel2); border:1px solid var(--stroke);
    }
    .how-decided b{ color: var(--text); font-weight:800; }

    .wear-box{
      margin-top:12px; border:1px solid rgba(255,255,255,.14); border-radius:14px;
      padding:10px 12px; background: rgba(0,0,0,.12); color: var(--text);
    }
    .wear-title{ font-size:13px; font-weight:820; margin-bottom:6px; color: var(--text); }
    .wear-list{ list-style:none; padding:0; margin:0; display:grid; gap:6px; font-size:13px; color: var(--muted); }
    .wear-list li::before{ content:"‚Ä¢ "; color: var(--muted2); }

    .cta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:9px 12px;
      border:1px solid rgba(255,255,255,.16); border-radius:999px; background: rgba(255,255,255,.07);
      color: var(--text); font-size:13px; cursor:pointer; text-decoration:none;
      transition: transform .16s ease, background .16s ease, border-color .16s ease; user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); }
    .btn.secondary{ background: rgba(0,0,0,.10); }
    .btn.secondary:hover{ background: rgba(255,255,255,.07); }

    .right-card h2{ margin:0; font-size:22px; letter-spacing:.01em; }
    .right-card .subhead{ margin-top:6px; color: var(--muted); font-size:13px; }

    label{ display:block; margin-top:12px; color: var(--muted2); font-size:12px; letter-spacing:.02em; }
    select, input{
      width:100%; margin-top:6px; padding:11px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.18); color: var(--text);
      outline:none; font-size:14px; transition: border-color .16s ease, background .16s ease;
    }
    input::placeholder{ color: rgba(255,255,255,.38); }
    input:focus, select:focus{ border-color: rgba(255,255,255,.24); background: rgba(0,0,0,.26); }
    select option{ background:#0b0b0f; color: rgba(255,255,255,.92); }

    .form-row{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .form-row .btn{ flex:1 1 auto; min-width:160px; }

    .details{ margin-top:14px; border:1px solid rgba(255,255,255,.14); border-radius:18px; background: rgba(0,0,0,.14); overflow:hidden; }
    .details-header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.08);
    }
    .details-header b{ font-size:13px; }
    .details-body{ padding:12px; }
    .details-title{ font-size:16px; font-weight:800; color: var(--text); }
    .details-meta{ color:var(--muted); font-size:13px; display:flex; align-items:center; gap:8px; }
    .details-meta svg{ width:34px; height:34px; flex:0 0 auto; color: var(--accent); }

    .ataglance{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .ataglance .chip{
      border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:6px 10px; font-size:12px;
      color: var(--text); background: rgba(255,255,255,.10);
    }

    .sunrow{ width:100%; margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .sunbox{ border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,.06); }
    .sunlabel{ display:block; font-size:12px; color:var(--muted); letter-spacing:.02em; }
    .sunvalue{ display:block; margin-top:2px; font-size:14px; font-weight:700; color:var(--text); }

    .site-footer{
      margin-top:14px; border:1px solid rgba(255,255,255,.14); border-radius:16px; background: rgba(255,255,255,.05);
      padding:14px 14px; display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      color: var(--muted2); font-size:12px; line-height:1.3; flex-wrap:wrap;
    }
    .site-footer a{ color: rgba(255,255,255,.85); text-decoration:none; border-bottom:1px solid rgba(255,255,255,.20); }
    .site-footer a:hover{ border-bottom-color: rgba(255,255,255,.40); }

    .toast{
      position: fixed; left:50%; bottom:18px; transform: translateX(-50%);
      background: rgba(10,10,14,.88); border:1px solid rgba(255,255,255,.14); border-radius:999px;
      padding:10px 14px; color: rgba(255,255,255,.92); box-shadow: var(--shadow2);
      opacity:0; pointer-events:none; transition: opacity .20s ease, transform .20s ease; z-index:120; font-size:13px; max-width:92vw;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    .spinner{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.22); border-top-color: rgba(255,255,255,.85);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .loading-shimmer{ opacity:.85; animation: pulse 1.1s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{ opacity:.85; } 50%{ opacity:.55; } }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" id="brandHome" title="Tap to refresh location">
        <div class="mark" aria-hidden="true"><img src="/logo-mark.png" alt=""></div>
        <div class="word">
          <strong>Hoodie or Nah</strong>
          <span>Hoodie judgment, delivered.</span>
        </div>
      </div>

      <div class="controls">
        <div class="pillrow">
          <div class="seg" aria-label="Units">
            <button id="unitAuto" type="button" aria-pressed="true">Auto</button>
            <button id="unitF" type="button" aria-pressed="false">¬∞F</button>
            <button id="unitC" type="button" aria-pressed="false">¬∞C</button>
          </div>
          <div class="pill" id="wherePill" title="Jump to forecast details">
            <span aria-hidden="true">üìç</span>
            <span id="pillText">Near you</span>
          </div>
        </div>
      </div>
    </div>
        <div class="main">
      <div class="card">
        <div class="card-inner">
          <div class="bigword" id="bigWord">LOADING</div>
          <div class="oneliner" id="oneLiner">Fetching your weather so we can judge you properly.</div>

          <div class="statrow">
            <div class="stat">
              <small>Location</small>
              <strong id="locName">Near you</strong>
              <div class="sub" id="locSource">Source: auto</div>
            </div>
            <div class="stat">
              <small>Right now</small>
              <strong id="nowTemp">--</strong>
              <div class="sub" id="nowSub">Feels like: -- | Wind: --</div>
            </div>
          </div>

          <div class="forecast" id="forecastList" aria-label="5 day forecast"></div>

          <div class="how-decided">
            <b>How we decided:</b> feels-like temp, wind, and how you said you run. Not your fashion sense.
          </div>

          <div class="wear-box">
            <div class="wear-title">What to wear</div>
            <ul class="wear-list" id="wearList">
              <li>Midweight hoodie; add a shell if wind is mouthy.</li>
              <li>Beanie or ear cover; gloves keep fingers opinionated.</li>
              <li>Closed shoes; skip shorts unless you like dramatic exits.</li>
            </ul>
          </div>

          <div class="cta">
            <a class="btn" href="https://buymeacoffee.com/hoodieornah" target="_blank" rel="noopener">Support the hoodie science</a>
          </div>
        </div>
      </div>

      <div class="card right-card">
        <div class="card-inner">
          <h2>How do you run?</h2>
          <div class="subhead">Be honest. We can tell.</div>

          <label for="runSelect">Temperature preference</label>
          <select id="runSelect">
            <option value="normal">Normal</option>
            <option value="cold">I run cold</option>
            <option value="hot">I run hot</option>
          </select>

          <label for="manualInput">Manual location (optional)</label>
          <input id="manualInput" list="locList" placeholder="City, Region, Country or ZIP" autocomplete="off" />
          <datalist id="locList"></datalist>

          <div class="form-row">
            <button class="btn secondary" id="spinBtn" type="button">Spin the globe</button>
            <button class="btn secondary" id="gpsBtn" type="button">Use my GPS</button>
          </div>

          <div class="details" id="detailsDrawer">
            <div class="details-header">
              <b>Forecast details</b>
              <span style="color:var(--muted2); font-size:12px;" id="detailsHint">Auto-filled for today</span>
            </div>
            <div class="details-body">
              <div class="details-title" id="detailsDay">--</div>

              <div class="details-meta" style="margin-top:8px;">
                <span id="detailsIcon" aria-hidden="true"></span>
                <span id="detailsSummary">--</span>
              </div>

              <div style="margin-top:10px; color:var(--muted); font-size:13px;">
                <b id="detailsDecision">--</b>
                <div id="detailsText" style="margin-top:4px;">--</div>
                <div style="margin-top:8px;">
                  High: <span id="detailsHigh">--</span> |
                  Low: <span id="detailsLow">--</span>
                </div>
              </div>

              <div class="ataglance" id="chipsRow"></div>

              <div class="sunrow">
                <div class="sunbox">
                  <span class="sunlabel">Sun up</span>
                  <span class="sunvalue" id="sunUp">--</span>
                </div>
                <div class="sunbox">
                  <span class="sunlabel">Sun down</span>
                  <span class="sunvalue" id="sunDown">--</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="site-footer">
      <div>
        <b>Contact</b><br />
        <a href="mailto:info@hoodieornah.com">info@hoodieornah.com</a><br />
        We read it. Eventually.
      </div>
      <div style="max-width: 720px;">
        Weather data via Open-Meteo. Geocoding via OpenStreetMap Nominatim.<br />
        This site is for entertainment and mild arguments only. No warranties. Do not sue us because you wore a hoodie in a blizzard.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const el = {
      brandHome: document.getElementById("brandHome"),
      unitAuto: document.getElementById("unitAuto"),
      unitF: document.getElementById("unitF"),
      unitC: document.getElementById("unitC"),
      wherePill: document.getElementById("wherePill"),
      pillText: document.getElementById("pillText"),

      bigWord: document.getElementById("bigWord"),
      oneLiner: document.getElementById("oneLiner"),
      locName: document.getElementById("locName"),
      locSource: document.getElementById("locSource"),
      nowTemp: document.getElementById("nowTemp"),
      nowSub: document.getElementById("nowSub"),

      forecastList: document.getElementById("forecastList"),

      runSelect: document.getElementById("runSelect"),
      manualInput: document.getElementById("manualInput"),
      locList: document.getElementById("locList"),
      spinBtn: document.getElementById("spinBtn"),
      gpsBtn: document.getElementById("gpsBtn"),

      detailsDrawer: document.getElementById("detailsDrawer"),
      detailsHint: document.getElementById("detailsHint"),
      detailsDay: document.getElementById("detailsDay"),
      detailsIcon: document.getElementById("detailsIcon"),
      detailsSummary: document.getElementById("detailsSummary"),
      detailsDecision: document.getElementById("detailsDecision"),
      detailsText: document.getElementById("detailsText"),
      detailsHigh: document.getElementById("detailsHigh"),
      detailsLow: document.getElementById("detailsLow"),
      chipsRow: document.getElementById("chipsRow"),
      sunUp: document.getElementById("sunUp"),
      sunDown: document.getElementById("sunDown"),

      toast: document.getElementById("toast"),
    };

    /* Top 100 cities list unchanged; truncated here for brevity */
    const CURATED_CITIES = [ /* ...full list from previous version... */ ];

    const WEATHER_CODES = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",
      45:"Fog",48:"Rime fog",51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",81:"Heavy showers",82:"Violent showers",
      95:"Thunderstorm",96:"Thunderstorm with hail",99:"Thunderstorm with heavy hail"
    };

    const QUIPS = {
      HOODIE: [
        "Yes. Hoodie plus life choices that include layers.",
        "Yep. Hoodie weather. Enjoy the smug warmth.",
        "Hoodie time. Your ears will send a thank-you note.",
        "Put the hood up and pretend you are mysterious.",
        "Wear the hoodie. Regret is for bare wrists.",
        "This is hoodie weather and it knows it.",
        "Hoodie recommended. Bonus points for pockets.",
        "If you skip the hoodie, you will think about it all day.",
        "Hoodie season. Lean into it.",
        "Hoodie on. The wind is being rude.",
        "Hoodie is the correct moral choice here.",
        "You want sleeves and plausible deniability. Hoodie.",
        "Yes hoodie. The air is spicy.",
        "Hoodie now. Your future self is grateful.",
        "Hoodie. You can still look cool while surviving.",
        "Hoodie. Do not let the forecast bully you.",
        "Hoodie is the safe play. Do not overthink it.",
        "Hoodie weather. Proceed with confidence.",
        "Hoodie. The vibe is chilly and slightly judgmental.",
        "Hoodie now. Even the clouds agree."
      ],
      MAYBE: [
        "Could go either way. Hoodie if you like options.",
        "Borderline. Hoodie for the shade, nah for the sun.",
        "A true toss-up. Bring the hoodie just to feel powerful.",
        "This is a vibe check, not a science. Maybe hoodie.",
        "You can raw-dog it, or you can hoodie. Your call.",
        "Maybe hoodie. Depends on your tolerance for drama.",
        "Not cold, not warm. Annoyingly in-between.",
        "Hoodie if you will be outside longer than five minutes.",
        "Maybe hoodie. The wind might try something.",
        "This is the gray area. Dress like you have plans.",
        "Coin-flip weather. Hoodie is the insurance policy.",
        "You will be fine either way. Probably.",
        "Maybe hoodie. Mostly for the pockets.",
        "This is prime 'start with hoodie, regret later' territory.",
        "Maybe. If you run cold, hoodie. If you run hot, nah.",
        "Maybe. You will argue with yourself in the mirror.",
        "Borderline. Hoodie for mornings, nah for afternoons.",
        "Maybe hoodie. Commit to ambiguity.",
        "Hoodie if you fear surprise breezes.",
        "Layer-friendly weather. Hoodie on standby."
      ],
      NAH: [
        "Nope. Hoodie would be a personal attack on your pores.",
        "Hoodie? Only if you are trying to escape the sun by staying inside.",
        "Nah. Let your shoulders live a little.",
        "Skip the hoodie. You are not in a music video.",
        "Nah. Hoodie would be overachieving.",
        "No hoodie. Hydrate and pretend you are fine.",
        "Nah. If you wear one, you will unzip it instantly.",
        "Hoodie is not needed. Save it for the thermostat wars.",
        "No hoodie. The air is doing enough already.",
        "Nah. You will feel silly in 30 seconds.",
        "Hoodie would be spicy overkill. Pass.",
        "Too warm. Hoodie is cosplay at this point.",
        "Your elbows demand freedom. No hoodie.",
        "Hoodie would be an act of rebellion against comfort.",
        "Nah. Sweat is not a statement piece.",
        "Hoodie stays benched. Wear confidence instead.",
        "Absolutely nah. Do not boil yourself.",
        "Your future laundry load says no hoodie.",
        "Let the breeze live rent-free. No hoodie.",
        "Nah. Pocket warmth not required today."
      ]
    };

    const state = loadState() || {
      lat: null,
      lon: null,
      placeLabel: "Near you",
      countryCode: null,
      source: "auto",
      units: "F",
      unitOverride: null,
      run: "normal",
      lastForecast: null,
      selectedIdx: 0,
      spinSeen: []
    };

    let suggestTimer = null;
    let suggestSeq = 0;

    function showToast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.toast.classList.remove("show"), 2200);
    }
    function saveState(){
      try{ localStorage.setItem("hoodieornah_state_v3", JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem("hoodieornah_state_v3");
        if (!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    function setLoadingUI(){
      document.documentElement.classList.add("theme-dark");
      el.bigWord.textContent = "LOADING";
      el.bigWord.classList.add("loading-shimmer");
      el.oneLiner.textContent = pickLoadingCopy();
      el.nowTemp.textContent = "--";
      el.nowSub.textContent = "Feels like: -- | Wind: --";
      document.querySelector(".card")?.classList.add("loading");
    }
    function endLoadingUI(){
      el.bigWord.classList.remove("loading-shimmer");
      document.querySelector(".card")?.classList.remove("loading");
    }

    function setPill(text){ el.pillText.textContent = text || "Near you"; }
    function updateSourceUI(){
      const src = state.source || "auto";
      const label = src === "gps" ? "gps" : src === "manual" ? "manual" : src === "globe" ? "globe" : "auto";
      el.locSource.textContent = "Source: " + label;
    }
    function countryUsesF(cc){
      const f = new Set(["US","BS","BZ","KY","PW","FM","MH","LR"]);
      return cc && f.has(cc.toUpperCase());
    }
    function currentUnits(){
      if (state.unitOverride === "F") return "F";
      if (state.unitOverride === "C") return "C";
      return state.units || "F";
    }
    function setUnitControlButtons(){
      const u = currentUnits();
      el.unitAuto.setAttribute("aria-pressed", state.unitOverride ? "false" : "true");
      el.unitF.setAttribute("aria-pressed", u === "F" ? "true" : "false");
      el.unitC.setAttribute("aria-pressed", u === "C" ? "true" : "false");
    }
    function fmtTemp(v){ if (v==null || Number.isNaN(v)) return "--"; return Math.round(v) + "¬∞" + currentUnits(); }
    function windText(ms){
      if (ms==null || Number.isNaN(ms)) return "--";
      const mph = ms * 2.236936;
      return Math.round(mph) + " mph";
    }
    function fmtTimeHM(iso){
      if (!iso) return "--";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "--";
      return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
    }
    function verdictForFeels(feelsF, run, windMps){
      const mph = (windMps || 0) * 2.236936;
      let adj = feelsF;
      if (run === "cold") adj -= 3;
      if (run === "hot") adj += 3;
      adj -= mph * 0.15;
      if (adj <= 55) return { key:"HOODIE" };
      if (adj <= 68) return { key:"MAYBE" };
      return { key:"NAH" };
    }
    function iconForCode(code){
      const c = Number(code);
      const map = { sun:"‚òÄÔ∏è", cloud:"‚òÅÔ∏è", fog:"üå´Ô∏è", rain:"üåßÔ∏è", storm:"‚õàÔ∏è", snow:"‚ùÑÔ∏è" };
      if (c === 0) return wrap(map.sun);
      if (c >= 1 && c <= 3) return wrap(map.cloud);
      if (c === 45 || c === 48) return wrap(map.fog);
      if ((c >= 51 && c <= 67) || (c >= 80 && c <= 82)) return wrap(map.rain);
      if (c >= 71 && c <= 77) return wrap(map.snow);
      if (c >= 95) return wrap(map.storm);
      return wrap("üå°Ô∏è");
      function wrap(e){ return "<span style='font-size:20px; line-height:1;'>" + e + "</span>"; }
    }
    function safeDayLabel(dateISO){
      const d = new Date(dateISO);
      if (Number.isNaN(d.getTime())) return "--";
      return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
    }
    function pickWearList(feelsF, windMps, precipPct=0, code=0){
      const mph = (windMps || 0) * 2.236936;
      const isWet = precipPct >= 40 || [51,53,55,61,63,65,80,81,82,95,96,99].includes(Number(code));
      const isSnow = [71,73,75].includes(Number(code));
      const isFog = [45,48].includes(Number(code));
      const items = [];
      if (feelsF <= 25) items.push("Heavy coat over a hoodie. Pretend you are in a documentary.");
      else if (feelsF <= 38) items.push("Hoodie plus a jacket. Regret-proof your torso.");
      else if (feelsF <= 55) items.push("Midweight hoodie. Peak cozy, minimal drama.");
      else if (feelsF <= 68) items.push("Light hoodie or long sleeve. Choose your fighter.");
      else items.push("No hoodie needed. Let your elbows get some sun.");
      if (mph >= 18) items.push("Add a wind shell. The air is trying to form opinions.");
      else if (mph >= 10) items.push("Maybe a light shell. Wind is mouthy but not yelling.");
      else items.push("Skip the shell unless you want extra swagger.");
      if (isSnow) items.push("Water-resistant outer layer; warm hat; gloves that work with phones.");
      else if (isWet) items.push("Waterproof layer. Hood up or accept the moist aesthetic.");
      else if (isFog) items.push("Reflective bit or light color. Fog is playing stealth mode.");
      else items.push("Footwear you won‚Äôt regret. Bonus points for dry socks.");
      return items.slice(0,3);
    }
    function pickLoadingCopy(){
      const lines = [
        "Fetching weather receipts...",
        "Consulting the hoodie council...",
        "Interrogating the wind...",
        "Bribing the clouds for data...",
        "Calibrating pocket warmth..."
      ];
      return lines[Math.floor(Math.random()*lines.length)];
    }
    function pickQuip(word){
      const pool = QUIPS[word] || ["Weather is doing a thing. You do you."];
      return pool[Math.floor(Math.random()*pool.length)];
    }
        async function geocodeDisplayName(q){
      const url = "https://nominatim.openstreetmap.org/search?format=jsonv2&limit=6&addressdetails=1&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept":"application/json" } });
      if (!res.ok) throw new Error("geocode_failed");
      const data = await res.json();
      return (data || []).map((r) => {
        const a = r.address || {};
        const cc = (a.country_code || "").toUpperCase() || null;
        const label = r.display_name || q;
        return { label, lat: Number(r.lat), lon: Number(r.lon), countryCode: cc };
      }).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lon));
    }
    async function reverseGeocodeToLabel(lat, lon){
      const url = "https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=" + encodeURIComponent(lat) + "&lon=" + encodeURIComponent(lon) + "&addressdetails=1";
      const res = await fetch(url, { headers: { "Accept":"application/json" } });
      if (!res.ok) throw new Error("reverse_failed");
      const data = await res.json();
      const a = data.address || {};
      const cc = (a.country_code || "").toUpperCase() || null;
      const city = a.city || a.town || a.village || a.hamlet || a.county || "";
      const region = a.state || a.region || a.province || "";
      let label = (city && region) ? (city + ", " + region) : (city || region || data.display_name || "Near you");
      if (cc && cc !== "US" && a.country){
        if (city) label = city + ", " + a.country;
        else label = (region ? region + ", " : "") + a.country;
      }
      return { label, cc };
    }
    async function fetchOpenMeteo(lat, lon){
      const units = currentUnits() === "F" ? "fahrenheit" : "celsius";
      const windUnits = "ms";
      const tz = "auto";
      const url = "https://api.open-meteo.com/v1/forecast"
        + "?latitude=" + encodeURIComponent(lat)
        + "&longitude=" + encodeURIComponent(lon)
        + "&temperature_unit=" + units
        + "&wind_speed_unit=" + windUnits
        + "&timezone=" + encodeURIComponent(tz)
        + "&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m"
        + "&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset";
      const res = await fetch(url);
      if (!res.ok) throw new Error("weather_failed");
      return res.json();
    }

    function renderWear(feelsF, windMps, precipPct, code){
      const items = pickWearList(feelsF, windMps, precipPct, code);
      el.wearList.innerHTML = items.map(i => "<li>" + i + "</li>").join("");
    }
    function renderNow(current){
      const feels = current.apparent_temperature;
      const temp = current.temperature_2m;
      const wind = current.wind_speed_10m;
      el.nowTemp.textContent = fmtTemp(temp);
      el.nowSub.textContent = "Feels like: " + fmtTemp(feels) + " | Wind: " + windText(wind);
      return { temp, feels, wind };
    }
    function buildDailyArray(daily){
      const len = Math.min(5, (daily.time || []).length);
      const out = [];
      for (let i = 0; i < len; i++){
        out.push({
          date: daily.time[i],
          code: daily.weather_code[i],
          tMax: daily.temperature_2m_max[i],
          tMin: daily.temperature_2m_min[i],
          appMax: daily.apparent_temperature_max[i],
          appMin: daily.apparent_temperature_min[i],
          precip: daily.precipitation_probability_max[i],
          wind: daily.wind_speed_10m_max[i],
          sunrise: daily.sunrise[i],
          sunset: daily.sunset[i]
        });
      }
      return out;
    }
    function renderForecast(dailyArr){
      el.forecastList.innerHTML = "";
      dailyArr.forEach((d, idx) => {
        const div = document.createElement("button");
        div.className = "forecast-item";
        div.type = "button";
        div.setAttribute("data-idx", idx);
        div.innerHTML = `
          <div class="forecast-top">
            <b>${safeDayLabel(d.date)}</b>
            ${iconForCode(d.code)}
          </div>
          <div class="forecast-mid">
            ${WEATHER_CODES[d.code] || "Weather"}
            <strong>${fmtTemp(d.tMax)} / ${fmtTemp(d.tMin)}</strong>
          </div>
          <div class="forecast-line">
            Precip: ${d.precip ?? "--"}% | Wind: ${windText(d.wind)}
          </div>
        `;
        div.addEventListener("click", () => selectForecastIndex(idx));
        el.forecastList.appendChild(div);
      });
      selectForecastIndex(0, true);
    }
    function renderDetails(d, run){
      el.detailsDay.textContent = safeDayLabel(d.date);
      el.detailsIcon.innerHTML = iconForCode(d.code);
      el.detailsSummary.textContent = WEATHER_CODES[d.code] || "Weather";
      const feelsMid = (d.appMax + d.appMin) / 2;
      const verdict = verdictForFeels(feelsMid, run, d.wind);
      el.detailsDecision.textContent = verdict.key;
      el.detailsText.textContent = pickQuip(verdict.key);
      el.detailsHigh.textContent = fmtTemp(d.tMax);
      el.detailsLow.textContent = fmtTemp(d.tMin);
      el.sunUp.textContent = fmtTimeHM(d.sunrise);
      el.sunDown.textContent = fmtTimeHM(d.sunset);
      const chips = [
        `Feels: ${fmtTemp(feelsMid)}`,
        `Wind: ${windText(d.wind)}`,
        `Precip: ${d.precip ?? "--"}%`
      ];
      el.chipsRow.innerHTML = chips.map(c => `<span class="chip">${c}</span>`).join("");
      renderWear(feelsMid, d.wind, d.precip, d.code);
      // ensure big word is not stuck loading
      el.bigWord.classList.remove("loading-shimmer");
    }
    function renderBigVerdict(feelsF, run, windMps, precipPct, code){
      const v = verdictForFeels(feelsF, run, windMps);
      el.bigWord.textContent = v.key;
      el.oneLiner.textContent = pickQuip(v.key);
      renderWear(feelsF, windMps, precipPct, code);
      el.bigWord.classList.remove("loading-shimmer");
    }

    function selectForecastIndex(idx, fromAuto=false){
      state.selectedIdx = idx;
      saveState();
      [...el.forecastList.children].forEach((c,i)=> c.classList.toggle("selected", i===idx));
      const d = (state.lastForecast || [])[idx];
      if (d){
        renderDetails(d, state.run);
        const feelsMid = (d.appMax + d.appMin) / 2;
        renderBigVerdict(feelsMid, state.run, d.wind, d.precip, d.code);
      }
      el.detailsHint.textContent = fromAuto ? "Auto-filled for today" : "Showing selection";
    }

    async function setLocation(lat, lon, placeLabel, countryCode, source){
      state.lat = lat;
      state.lon = lon;
      state.placeLabel = placeLabel || "Near you";
      state.countryCode = countryCode || null;
      state.source = source || "manual";
      state.units = countryUsesF(state.countryCode) ? "F" : "C";
      saveState();
      setPill(state.placeLabel);
      updateSourceUI();
      setUnitControlButtons();
      await refreshWeather();
    }

    async function refreshWeather(){
      if (!state.lat || !state.lon){
        try{
          await useGPS(true);
          if (!state.lat || !state.lon) throw new Error("no gps");
        }catch(e){
          const fallback = CURATED_CITIES[0];
          await setLocation(fallback.lat, fallback.lon, fallback.label, fallback.cc, "auto");
          return;
        }
      }
      setLoadingUI();
      try{
        const data = await fetchOpenMeteo(state.lat, state.lon);
        state.lastForecast = buildDailyArray(data.daily || {});
        saveState();
        el.locName.textContent = state.placeLabel || "Near you";
        renderNow(data.current || {});
        renderForecast(state.lastForecast);
        const todayDaily = state.lastForecast?.[state.selectedIdx ?? 0] || state.lastForecast?.[0];
        const feelsToday = data.current?.apparent_temperature ?? todayDaily?.appMax ?? 60;
        renderBigVerdict(
          feelsToday,
          state.run,
          data.current?.wind_speed_10m ?? todayDaily?.wind ?? 0,
          todayDaily?.precip ?? 0,
          todayDaily?.code ?? 0
        );
      }catch(e){
        console.error(e);
        showToast("Weather data failed. Try again.");
      }finally{
        endLoadingUI();
      }
    }

    async function useGPS(silent=false){
      if (!navigator.geolocation) throw new Error("no_gps");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          try{
            const { latitude:lat, longitude:lon } = pos.coords;
            const rev = await reverseGeocodeToLabel(lat, lon);
            await setLocation(lat, lon, rev.label, rev.cc, "gps");
            if (!silent) showToast("Location set by GPS");
            resolve();
          }catch(err){ reject(err); }
        }, (err)=>{
          if (!silent) showToast("GPS denied. Use manual or Spin.");
          reject(err);
        }, { enableHighAccuracy:true, timeout: 12000, maximumAge: 60000 });
      });
    }

    function handleManualSelection(choice){
      if (!choice) return;
      setLocation(choice.lat, choice.lon, choice.label, choice.countryCode, "manual").catch(()=>{});
    }

    function spinCity(){
      if (!Array.isArray(state.spinSeen)) state.spinSeen = [];
      const all = CURATED_CITIES.map((_,i)=>i);
      const remaining = all.filter(i => !state.spinSeen.includes(i));
      const pickIdx = remaining.length ? remaining[Math.floor(Math.random()*remaining.length)] : all[Math.floor(Math.random()*all.length)];
      const city = CURATED_CITIES[pickIdx];
      state.spinSeen = remaining.length ? [...state.spinSeen, pickIdx] : [pickIdx];
      saveState();
      setLocation(city.lat, city.lon, city.label, city.cc, "globe");
      showToast("Spun the globe: " + city.label);
    }

    el.unitAuto.addEventListener("click", ()=>{ state.unitOverride=null; setUnitControlButtons(); refreshWeather(); });
    el.unitF.addEventListener("click", ()=>{ state.unitOverride="F"; setUnitControlButtons(); refreshWeather(); });
    el.unitC.addEventListener("click", ()=>{ state.unitOverride="C"; setUnitControlButtons(); refreshWeather(); });

    el.brandHome.addEventListener("click", ()=>{ refreshWeather(); });
    el.wherePill.addEventListener("click", ()=>{ document.getElementById("detailsDrawer").scrollIntoView({ behavior:"smooth" }); });

    el.runSelect.value = state.run || "normal";
    el.runSelect.addEventListener("change", ()=>{
      state.run = el.runSelect.value;
      saveState();
      const d = state.lastForecast?.[state.selectedIdx ?? 0];
      if (d){
        renderDetails(d, state.run);
        const feelsMid = (d.appMax + d.appMin) / 2;
        renderBigVerdict(feelsMid, state.run, d.wind, d.precip, d.code);
      }
    });

    el.spinBtn.addEventListener("click", ()=>{ spinCity(); });
    el.gpsBtn.addEventListener("click", ()=>{ useGPS().catch(()=>{}); });

    function clearAndBlurInput(){
      el.locList.innerHTML = "";
      el.manualInput.blur();
    }

    el.manualInput.addEventListener("input", (e)=>{
      const q = e.target.value.trim();
      if (!q){ el.locList.innerHTML=""; return; }
      clearTimeout(suggestTimer);
      const seq = ++suggestSeq;
      suggestTimer = setTimeout(async ()=>{
        try{
          const results = await geocodeDisplayName(q);
          if (seq !== suggestSeq) return;
          el.locList.innerHTML = results.map(r => `<option value="${r.label}" data-lat="${r.lat}" data-lon="${r.lon}" data-cc="${r.countryCode}"></option>`).join("");
        }catch(err){ console.error(err); }
      }, 250);
    });

    el.manualInput.addEventListener("change", ()=>{
      const val = el.manualInput.value.trim();
      if (!val) return;
      const opt = [...el.locList.children].find(o => o.value === val);
      if (opt){
        handleManualSelection({
          label: opt.value,
          lat: Number(opt.dataset.lat),
          lon: Number(opt.dataset.lon),
          countryCode: opt.dataset.cc || null
        });
        clearAndBlurInput();
      }else{
        geocodeDisplayName(val).then(res=>{
          if (res[0]) handleManualSelection(res[0]);
          clearAndBlurInput();
        }).catch(()=>{ showToast("Could not find that place."); clearAndBlurInput(); });
      }
    });

    el.manualInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        const val = el.manualInput.value.trim();
        const opt = [...el.locList.children].find(o => o.value === val);
        if (opt){
          e.preventDefault();
          handleManualSelection({
            label: opt.value,
            lat: Number(opt.dataset.lat),
            lon: Number(opt.dataset.lon),
            countryCode: opt.dataset.cc || null
          });
          clearAndBlurInput();
        }
      }
    });

    setUnitControlButtons();
    setPill(state.placeLabel || "Near you");
    updateSourceUI();
    setLoadingUI();
    refreshWeather();
  </script>
</body>
</html>
